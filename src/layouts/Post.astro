---
import Base from './Base.astro';
import TableOfContents from '../components/TableOfContents.astro';
import EditSettingsModal from '../components/EditSettingsModal.astro';

interface Props {
  title: string;
  date: Date;
  description: string;
  draft?: boolean;
  slug: string;
  headings: Array<{
    depth: number;
    slug: string;
    text: string;
  }>;
}

const { title, date, description, draft, slug, headings } = Astro.props;
const isDev = import.meta.env.DEV;

// Calculate reading time (roughly 200 words per minute)
const content = await Astro.slots.render('default');
const wordCount = content.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);

// Format date
const formattedDate = date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<Base title={`${title} | David Larpent`} description={description}>
  <div class="post-layout">
    <TableOfContents headings={headings} />

    <article class="post-article" data-post-slug={slug}>
      <header class="post-header">
        <h1
          class="post-title"
          contenteditable={isDev}
          data-field="title"
        >{title}</h1>
        <p
          class="post-description"
          contenteditable={isDev}
          data-field="description"
        >{description}</p>
        <div class="post-meta">
          <time datetime={date.toISOString()}>{formattedDate}</time>
          <span> · {readingTime} min read</span>
          {draft && <span class="draft-badge">Draft</span>}
        </div>
      </header>
      <div
        class="post-content"
        contenteditable={isDev}
        data-field="content"
      >
        <slot />
      </div>
      <a href="/" class="back-link">← Back to essays</a>
    </article>

    {isDev && (
      <>
        <div class="edit-controls">
          <span class="save-status"></span>
          <button class="settings-button" title="Post settings">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
            </svg>
          </button>
          <button class="save-button" title="Save changes (Ctrl/Cmd+S)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17 21 17 13 7 13 7 21"/>
              <polyline points="7 3 7 8 15 8"/>
            </svg>
          </button>
        </div>
        <EditSettingsModal date={date} draft={draft} slug={slug} />
      </>
    )}
  </div>
</Base>

{isDev && (
  <script is:inline>
    // Make footnotes non-editable to prevent corruption
    document.addEventListener('DOMContentLoaded', () => {
      // Footnote references (superscript links)
      document.querySelectorAll('sup a[data-footnote-ref]').forEach(el => {
        el.setAttribute('contenteditable', 'false');
        el.style.cursor = 'not-allowed';
        el.style.opacity = '0.7';
        el.title = 'Footnotes cannot be edited inline';
      });

      // Also make the sup element non-editable
      document.querySelectorAll('sup:has(a[data-footnote-ref])').forEach(el => {
        el.setAttribute('contenteditable', 'false');
      });

      // Footnotes section
      const footnotesSection = document.querySelector('.footnotes');
      if (footnotesSection) {
        footnotesSection.setAttribute('contenteditable', 'false');
        footnotesSection.style.opacity = '0.7';
        footnotesSection.style.cursor = 'not-allowed';
      }
    });
  </script>
)}

{isDev && (
  <script>
    // Dev-only inline editing functionality
    const article = document.querySelector('.post-article') as HTMLElement;
    const slug = article?.dataset.postSlug;
    const saveButton = document.querySelector('.save-button') as HTMLButtonElement;
    const settingsButton = document.querySelector('.settings-button') as HTMLButtonElement;
    const saveStatus = document.querySelector('.save-status') as HTMLElement;

    function getEditableContent() {
      const titleEl = document.querySelector('[data-field="title"]') as HTMLElement;
      const descriptionEl = document.querySelector('[data-field="description"]') as HTMLElement;
      const contentEl = document.querySelector('[data-field="content"]') as HTMLElement;

      // Clone content to avoid mutating DOM
      const contentClone = contentEl?.cloneNode(true) as HTMLElement;

      // Remove footnotes section (will be preserved from original file)
      const footnotesSection = contentClone?.querySelector('.footnotes');
      if (footnotesSection) {
        footnotesSection.remove();
      }

      // Remove footnote reference superscripts (will be preserved from original)
      contentClone?.querySelectorAll('sup:has(a[data-footnote-ref]), sup a[data-footnote-ref]').forEach(el => {
        // Find the parent sup element if we're on the anchor
        const sup = el.tagName === 'SUP' ? el : el.closest('sup');
        if (sup) {
          sup.remove();
        }
      });

      return {
        title: titleEl?.textContent?.trim() || '',
        description: descriptionEl?.textContent?.trim() || '',
        content: contentClone?.innerHTML || ''
      };
    }

    function showStatus(message: string, isError = false) {
      if (!saveStatus) return;
      saveStatus.textContent = message;
      saveStatus.classList.toggle('error', isError);
      saveStatus.classList.toggle('success', !isError && message !== '');
    }

    async function savePost() {
      if (!slug) {
        showStatus('Error: No slug', true);
        return;
      }

      const { title, description, content } = getEditableContent();

      // Validate non-empty
      if (!title?.trim() || !description?.trim() || !content?.trim()) {
        showStatus('Error: Title, description, and content required', true);
        return;
      }

      showStatus('Saving...');

      try {
        const response = await fetch('/api/save-post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug, title, description, content })
        });

        const result = await response.json();

        if (result.success) {
          showStatus('Saved!');
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          showStatus(`Error: ${result.message}`, true);
        }
      } catch (error) {
        showStatus(`Error: ${error}`, true);
      }
    }

    // Event listeners
    saveButton?.addEventListener('click', savePost);

    // Keyboard shortcut: Ctrl/Cmd + S to save
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        savePost();
      }
    });

    // Settings button click is handled by EditSettingsModal component
  </script>
)}

---
import Base from './Base.astro';
import TableOfContents from '../components/TableOfContents.astro';
import EditSettingsModal from '../components/EditSettingsModal.astro';
import EditToolbar from '../components/EditToolbar.astro';
import SyndicationModal from '../components/SyndicationModal.astro';
import ImageGenPanel from '../components/ImageGenPanel.astro';
import SketchScrollReveal from '../components/SketchScrollReveal.astro';

interface Props {
  title: string;
  date: Date;
  description: string;
  draft?: boolean;
  slug: string;
  tags?: string[];
  featureImage?: string;
  relatedPosts?: Array<{
    slug: string;
    title: string;
    description: string;
    sharedTags: string[];
  }>;
  headings: Array<{
    depth: number;
    slug: string;
    text: string;
  }>;
}

const { title, date, description, draft, slug, tags = [], featureImage, relatedPosts = [], headings } = Astro.props;
const isDev = import.meta.env.DEV;

// Calculate reading time (roughly 200 words per minute)
const content = await Astro.slots.render('default');
const wordCount = content.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);

// Format date
const formattedDate = date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// JSON-LD Article Schema
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "author": {
    "@type": "Person",
    "name": "David Larpent",
    "url": "https://davidlarpent.com/about"
  },
  "publisher": {
    "@type": "Person",
    "name": "David Larpent",
    "url": "https://davidlarpent.com"
  },
  "datePublished": date.toISOString(),
  "dateModified": date.toISOString(),
  "url": `https://davidlarpent.com/posts/${slug}`,
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://davidlarpent.com/posts/${slug}`
  },
  "wordCount": wordCount,
  "timeRequired": `PT${readingTime}M`,
  "keywords": tags.join(", "),
  "inLanguage": "en",
  "articleSection": "Notes"
};
---

<Base
  title={`${title} | David Larpent`}
  description={description}
  image={featureImage || undefined}
  type="article"
  keywords={tags}
  articleMeta={{
    publishedTime: date.toISOString(),
    author: "David Larpent",
    tags: tags
  }}
>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
  <div class="post-layout">
    <TableOfContents headings={headings} tags={tags} />

    <article class="post-article" data-post-slug={slug} data-post-description={description} data-post-tags={JSON.stringify(tags)} data-post-category={tags.length > 0 ? 'work' : 'work'}>
      <header class="post-header">
        <h1 class="post-title" contenteditable={isDev} data-field="title">{title}</h1>
        <p class="post-description" contenteditable={isDev} data-field="description">{description}</p>
        <div class="post-meta">
          <time datetime={date.toISOString()}>{formattedDate}</time>
          <span> · {readingTime} min read</span>
          {draft && <span class="draft-badge">Draft</span>}
          {isDev && (
            <label class="publish-toggle" data-slug={slug}>
              <input type="checkbox" checked={!draft} />
              <span class="publish-toggle-slider"></span>
              <span class="publish-toggle-text">{draft ? 'Publish' : 'Published'}</span>
            </label>
          )}
        </div>
        <div class="feature-image-wrapper" data-slug={slug} data-title={title} data-description={description}>
          {featureImage ? (
            <img src={featureImage} alt={title} class="feature-image sketch-illustration" />
          ) : isDev ? (
            <div class="feature-image-placeholder" title="Click to generate feature image">
              <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="10" y="10" width="100" height="100" rx="2" stroke="currentColor" stroke-width="0.75" stroke-dasharray="4 3" />
                <line x1="10" y1="40" x2="110" y2="40" stroke="currentColor" stroke-width="0.5" opacity="0.3" />
                <line x1="40" y1="10" x2="40" y2="110" stroke="currentColor" stroke-width="0.5" opacity="0.3" />
                <rect x="48" y="48" width="24" height="24" rx="1" stroke="currentColor" stroke-width="0.75" />
                <circle cx="56" cy="56" r="3" stroke="currentColor" stroke-width="0.5" />
                <polyline points="48,72 56,60 64,66 72,54 72,72" stroke="currentColor" stroke-width="0.5" fill="none" />
                <line x1="56" y1="82" x2="64" y2="82" stroke="currentColor" stroke-width="0.75" opacity="0.5" />
                <line x1="60" y1="78" x2="60" y2="86" stroke="currentColor" stroke-width="0.75" opacity="0.5" />
              </svg>
            </div>
          ) : null}
        </div>
      </header>
      <div class="post-content" contenteditable={isDev} data-field="content">
        <slot />
      </div>

      {relatedPosts.length > 0 && (
        <aside class="related-posts">
          <h2>Related Notes</h2>
          <ul class="related-posts-list">
            {relatedPosts.map(related => (
              <li class="related-post-item">
                <a href={`/posts/${related.slug}`} class="related-post-link">
                  <h3>{related.title}</h3>
                  {related.description && (
                    <p class="related-post-description">{related.description}</p>
                  )}
                  <div class="related-post-tags">
                    {related.sharedTags.map(tag => (
                      <span class="shared-tag">#{tag}</span>
                    ))}
                  </div>
                </a>
              </li>
            ))}
          </ul>
        </aside>
      )}

      <a href="/" class="back-link">← Back to notes</a>
    </article>

    <SketchScrollReveal />

    {isDev && (
      <>
        <EditToolbar />
        <div class="edit-controls">
          <span class="save-status"></span>
          <button class="linkedin-copy-button" title="Copy for LinkedIn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
            </svg>
          </button>
          <button class="substack-copy-button" title="Copy for Substack">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M22.539 8.242H1.46V5.406h21.08v2.836zM1.46 10.812V24L12 18.11 22.54 24V10.812H1.46zM22.54 0H1.46v2.836h21.08V0z"/>
            </svg>
          </button>
          <button class="settings-button" title="Post settings">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
            </svg>
          </button>
          <button class="save-button" title="Save changes (Ctrl/Cmd+S)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17 21 17 13 7 13 7 21"/>
              <polyline points="7 3 7 8 15 8"/>
            </svg>
          </button>
        </div>
        <EditSettingsModal date={date} draft={draft} slug={slug} />
        <SyndicationModal />
        <ImageGenPanel />
      </>
    )}
  </div>
</Base>

{isDev && (
  <script is:inline>
    // Make footnotes non-editable to prevent corruption
    document.addEventListener('DOMContentLoaded', () => {
      // Footnote references (superscript links)
      document.querySelectorAll('sup a[data-footnote-ref]').forEach(el => {
        el.setAttribute('contenteditable', 'false');
        el.style.cursor = 'not-allowed';
        el.style.opacity = '0.7';
        el.title = 'Footnotes cannot be edited inline';
      });

      // Also make the sup element non-editable
      document.querySelectorAll('sup:has(a[data-footnote-ref])').forEach(el => {
        el.setAttribute('contenteditable', 'false');
      });

      // Footnotes section
      const footnotesSection = document.querySelector('.footnotes');
      if (footnotesSection) {
        footnotesSection.setAttribute('contenteditable', 'false');
        footnotesSection.style.opacity = '0.7';
        footnotesSection.style.cursor = 'not-allowed';
      }
    });
  </script>
)}

{isDev && (
  <script>
    // Dev-only inline editing functionality
    const article = document.querySelector('.post-article') as HTMLElement;
    const slug = article?.dataset.postSlug;
    const saveButton = document.querySelector('.save-button') as HTMLButtonElement;
    const settingsButton = document.querySelector('.settings-button') as HTMLButtonElement;
    const saveStatus = document.querySelector('.save-status') as HTMLElement;

    function getEditableContent() {
      const titleEl = document.querySelector('[data-field="title"]') as HTMLElement;
      const descriptionEl = document.querySelector('[data-field="description"]') as HTMLElement;
      const contentEl = document.querySelector('[data-field="content"]') as HTMLElement;

      // Clone content to avoid mutating DOM
      const contentClone = contentEl?.cloneNode(true) as HTMLElement;

      // Remove footnotes section (will be preserved from original file)
      const footnotesSection = contentClone?.querySelector('.footnotes');
      if (footnotesSection) {
        footnotesSection.remove();
      }

      // Remove footnote reference superscripts (will be preserved from original)
      contentClone?.querySelectorAll('sup:has(a[data-footnote-ref])').forEach(el => {
        el.remove();
      });

      return {
        title: titleEl?.textContent?.trim() || '',
        description: descriptionEl?.textContent?.trim() || '',
        content: contentClone?.innerHTML || ''
      };
    }

    function showStatus(message: string, isError = false) {
      if (!saveStatus) return;
      saveStatus.textContent = message;
      saveStatus.classList.toggle('error', isError);
      saveStatus.classList.toggle('success', !isError && message !== '');
    }

    async function savePost() {
      if (!slug) {
        showStatus('Error: No slug', true);
        return;
      }

      const { title, description, content } = getEditableContent();

      // Validate non-empty
      if (!title?.trim() || !description?.trim() || !content?.trim()) {
        showStatus('Error: Title, description, and content required', true);
        return;
      }

      showStatus('Saving...');

      try {
        const response = await fetch('/api/save-post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug, title, description, content })
        });

        const result = await response.json();

        if (result.success) {
          showStatus('Saved!');
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          showStatus(`Error: ${result.message}`, true);
        }
      } catch (error) {
        showStatus(`Error: ${error}`, true);
      }
    }

    // Event listeners
    saveButton?.addEventListener('click', savePost);

    // Keyboard shortcut: Ctrl/Cmd + S to save
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        savePost();
      }
    });

    // LinkedIn button - opens syndication modal
    const linkedinButton = document.querySelector('.linkedin-copy-button');
    linkedinButton?.addEventListener('click', () => {
      const titleEl = document.querySelector('[data-field="title"]') as HTMLElement;
      const contentEl = document.querySelector('[data-field="content"]') as HTMLElement;
      const descriptionEl = document.querySelector('[data-field="description"]') as HTMLElement;

      const postTitle = titleEl?.textContent?.trim() || '';
      const postDescription = descriptionEl?.textContent?.trim() || '';

      // Get first few paragraphs from content
      const paragraphs = Array.from(contentEl?.querySelectorAll('p') || [])
        .slice(0, 3)
        .map(p => p.textContent?.trim())
        .filter(Boolean);

      const excerpt = paragraphs.join('\n\n');

      // Build naive LinkedIn excerpt
      const linkedinText = `${postTitle}\n\n${excerpt}\n\nRead the full note: https://davidlarpent.com/posts/${slug}`;

      // Get tags from article data attribute
      const postTags = JSON.parse(article?.dataset.postTags || '[]');

      const featureImg = document.querySelector('.feature-image') as HTMLImageElement;
      const ogImage = featureImg?.getAttribute('src') || '';

      (window as any).openSyndicationModal({
        slug,
        title: postTitle,
        description: postDescription,
        tags: postTags,
        category: article?.dataset.postCategory || 'work',
        platform: 'linkedin',
        linkedinText,
        substackText: '',
        ogImage
      });
    });

    // Substack button - opens syndication modal
    const substackButton = document.querySelector('.substack-copy-button');
    substackButton?.addEventListener('click', async () => {
      const titleEl = document.querySelector('[data-field="title"]') as HTMLElement;
      const descriptionEl = document.querySelector('[data-field="description"]') as HTMLElement;

      const postTitle = titleEl?.textContent?.trim() || '';
      const postDescription = descriptionEl?.textContent?.trim() || '';

      // Fetch the raw markdown from the file via API
      const response = await fetch(`/api/get-post-markdown?slug=${slug}`);
      const data = await response.json();

      let substackText = '';
      if (data.success) {
        substackText = `${data.markdown}\n\n---\nOriginally published at davidlarpent.com`;
      } else {
        showStatus('Error: Could not fetch markdown', true);
      }

      // Get tags from article data attribute
      const postTags = JSON.parse(article?.dataset.postTags || '[]');

      const featureImg2 = document.querySelector('.feature-image') as HTMLImageElement;
      const ogImage2 = featureImg2?.getAttribute('src') || '';

      (window as any).openSyndicationModal({
        slug,
        title: postTitle,
        description: postDescription,
        tags: postTags,
        category: article?.dataset.postCategory || 'work',
        platform: 'substack',
        linkedinText: '',
        substackText,
        ogImage: ogImage2
      });
    });

    // Settings button click is handled by EditSettingsModal component

    // Feature image click handler
    const featureImageWrapper = document.querySelector('.feature-image-wrapper') as HTMLElement;
    if (featureImageWrapper) {
      featureImageWrapper.addEventListener('click', () => {
        const wrapperSlug = featureImageWrapper.dataset.slug || '';
        const wrapperTitle = featureImageWrapper.dataset.title || '';
        const wrapperDescription = featureImageWrapper.dataset.description || '';
        const existingImg = featureImageWrapper.querySelector('.feature-image') as HTMLImageElement;

        window.dispatchEvent(new CustomEvent('feature-image-request', {
          detail: {
            slug: wrapperSlug,
            title: wrapperTitle,
            description: wrapperDescription,
            currentImage: existingImg?.src || '',
          }
        }));
      });

      // Listen for feature image set event
      window.addEventListener('feature-image-set', ((e: CustomEvent) => {
        const { path } = e.detail;
        if (!path) return;

        // Update DOM: replace placeholder or existing image
        featureImageWrapper.innerHTML = `<img src="${path}" alt="${featureImageWrapper.dataset.title || ''}" class="feature-image sketch-illustration" />`;

        // Re-attach click handler on new image
        featureImageWrapper.style.cursor = 'pointer';
      }) as EventListener);
    }

    // Publish toggle
    const publishToggle = document.querySelector('.publish-toggle') as HTMLLabelElement;
    const publishCheckbox = publishToggle?.querySelector('input[type="checkbox"]') as HTMLInputElement;
    publishCheckbox?.addEventListener('change', async () => {
      const toggleSlug = publishToggle.dataset.slug;
      if (!toggleSlug) return;

      const newDraft = !publishCheckbox.checked;

      const frontmatterUpdate: Record<string, any> = { draft: newDraft };
      // When publishing, set date to today
      if (!newDraft) {
        frontmatterUpdate.date = new Date().toISOString().split('T')[0];
      }

      showStatus('Saving...');

      try {
        const response = await fetch('/api/save-post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug: toggleSlug, frontmatter: frontmatterUpdate })
        });

        const result = await response.json();

        if (result.success) {
          // Push to deploy
          try {
            await fetch('/api/git-push', { method: 'POST' });
          } catch (pushError) {
            console.log('Git push skipped:', pushError);
          }
          showStatus('Saved!');
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          showStatus(`Error: ${result.message}`, true);
        }
      } catch (error) {
        showStatus(`Error: ${error}`, true);
      }
    });
  </script>
)}

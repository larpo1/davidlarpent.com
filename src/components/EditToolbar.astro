---
// Floating WYSIWYG toolbar component
// Link creation wraps selection in a marker span immediately, then swaps for <a> on submit
---

<div id="edit-toolbar" class="edit-toolbar" style="display: none;">
  <button data-command="bold" title="Bold (Ctrl+B)"><strong>B</strong></button>
  <button data-command="italic" title="Italic (Ctrl+I)"><em>I</em></button>
  <button data-command="createLink" title="Add Link (Ctrl+K)">L</button>
  <button data-command="formatBlock" data-value="h2" title="Heading 2">2</button>
  <button data-command="formatBlock" data-value="h3" title="Heading 3">3</button>
  <button data-command="insertUnorderedList" title="Bullet List">â€¢</button>
  <button data-command="formatBlock" data-value="pre" title="Code Block">&lt;&gt;</button>
  <button data-command="generateImage" title="Generate sketch illustration">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 19l7-7 3 3-7 7-3-3z"/>
      <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
      <path d="M2 2l7.586 7.586"/>
      <circle cx="11" cy="11" r="2"/>
    </svg>
  </button>
</div>

<div id="link-input-popover" class="link-input-popover" style="display: none;">
  <input type="text" id="link-url-input" placeholder="Paste URL" />
  <button id="link-submit-btn" type="button">Add</button>
</div>

<div id="link-inspect-popover" class="link-inspect-popover" style="display: none;">
  <span id="link-inspect-url" class="link-inspect-url"></span>
  <button id="link-inspect-open" type="button" class="link-inspect-open-btn">Open</button>
  <button id="link-inspect-remove" type="button" class="link-inspect-remove-btn">Remove</button>
</div>

<div id="image-prompt-popover" class="image-prompt-popover" style="display: none;">
  <input type="text" id="image-prompt-input" placeholder="Describe the sketch..." />
  <button id="image-prompt-submit" type="button">Go</button>
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const toolbar = document.getElementById('edit-toolbar');
    const linkPopover = document.getElementById('link-input-popover');
    const linkInput = document.getElementById('link-url-input');
    const linkSubmitBtn = document.getElementById('link-submit-btn');
    const contentEditable = document.querySelector('[contenteditable][data-field="content"]') || document.querySelector('[contenteditable][data-field="about"]');
    const linkInspectPopover = document.getElementById('link-inspect-popover');
    const linkInspectUrl = document.getElementById('link-inspect-url');
    const linkInspectOpenBtn = document.getElementById('link-inspect-open');
    const linkInspectRemoveBtn = document.getElementById('link-inspect-remove');
    const imagePromptPopover = document.getElementById('image-prompt-popover');
    const imagePromptInput = document.getElementById('image-prompt-input');
    const imagePromptSubmit = document.getElementById('image-prompt-submit');

    if (!toolbar || !contentEditable || !linkPopover || !linkInput || !linkSubmitBtn) return;

    // Currently inspected link element
    var inspectedLink = null;

    // Walk up from a node to find a parent <a> within the contenteditable
    function findParentLink(node) {
      while (node && node !== contentEditable) {
        if (node.nodeType === 1 && node.tagName === 'A') return node;
        node = node.parentNode;
      }
      return null;
    }

    // Show or hide the link inspect popover
    function updateLinkInspectPopover(selection) {
      if (!linkInspectPopover) return;

      // Don't show while creating a new link
      if (linkPopover.style.display !== 'none') {
        hideLinkInspectPopover();
        return;
      }

      if (!selection || !selection.anchorNode || !contentEditable.contains(selection.anchorNode)) {
        hideLinkInspectPopover();
        return;
      }

      var anchor = findParentLink(selection.anchorNode);
      if (anchor) {
        showLinkInspectPopover(anchor);
      } else {
        hideLinkInspectPopover();
      }
    }

    function showLinkInspectPopover(anchor) {
      inspectedLink = anchor;
      var url = anchor.getAttribute('href') || '';
      var displayUrl = url.length > 40 ? url.substring(0, 40) + '...' : url;
      linkInspectUrl.textContent = displayUrl;
      linkInspectUrl.title = url;

      var anchorRect = anchor.getBoundingClientRect();
      linkInspectPopover.style.top = (anchorRect.bottom + window.scrollY + 4) + 'px';
      linkInspectPopover.style.left = (anchorRect.left + window.scrollX) + 'px';
      linkInspectPopover.style.display = 'flex';
    }

    function hideLinkInspectPopover() {
      if (linkInspectPopover) {
        linkInspectPopover.style.display = 'none';
      }
      inspectedLink = null;
    }

    // Show toolbar on text selection
    document.addEventListener('selectionchange', () => {
      // Don't hide toolbar while link input is visible
      if (linkPopover.style.display !== 'none') return;
      // Don't hide toolbar while a marker exists (user is mid-link-creation)
      if (document.getElementById('link-marker')) return;

      const selection = window.getSelection();

      // Update link inspect popover (works for collapsed or non-collapsed selection)
      updateLinkInspectPopover(selection);

      if (!selection || selection.isCollapsed || !contentEditable.contains(selection.anchorNode)) {
        toolbar.style.display = 'none';
        return;
      }

      // Position toolbar relative to selection
      const range = selection.getRangeAt(0);
      const rect = range.getBoundingClientRect();
      const contentRect = contentEditable.getBoundingClientRect();

      toolbar.style.display = 'flex';

      if (contentRect.left < 60) {
        toolbar.style.flexDirection = 'row';
        toolbar.style.top = (rect.top + window.scrollY - 40) + 'px';
        toolbar.style.left = rect.left + 'px';
        toolbar.style.transform = 'none';
      } else {
        toolbar.style.flexDirection = 'column';
        toolbar.style.top = (rect.top + window.scrollY) + 'px';
        toolbar.style.left = (contentRect.left - 36) + 'px';
        toolbar.style.transform = 'translateX(-100%)';
      }

      updateToolbarState(toolbar);
    });

    // Prevent toolbar from stealing focus/selection
    toolbar.addEventListener('mousedown', function(e) {
      e.preventDefault();
    });

    // Remove an existing link marker, restoring its text content
    function removeMarker() {
      var marker = document.getElementById('link-marker');
      if (marker) {
        var parent = marker.parentNode;
        while (marker.firstChild) {
          parent.insertBefore(marker.firstChild, marker);
        }
        parent.removeChild(marker);
        parent.normalize(); // Merge adjacent text nodes
      }
    }

    // Step 1: Wrap selected text in a highlighted marker span IMMEDIATELY
    function showLinkInput() {
      var sel = window.getSelection();
      if (!sel || sel.rangeCount === 0 || sel.isCollapsed) return;

      var range = sel.getRangeAt(0);

      // Wrap selection in a marker span while we still have the live selection
      var marker = document.createElement('span');
      marker.id = 'link-marker';
      marker.style.background = 'rgba(107, 164, 255, 0.3)';
      marker.style.borderRadius = '2px';
      try {
        range.surroundContents(marker);
      } catch (e) {
        // Cross-element selection fallback
        marker.appendChild(range.extractContents());
        range.insertNode(marker);
      }

      // Clear selection (text is now visually highlighted by the marker)
      sel.removeAllRanges();

      // Position and show the URL input
      var toolbarRect = toolbar.getBoundingClientRect();
      linkPopover.style.top = (toolbarRect.bottom + window.scrollY + 4) + 'px';
      linkPopover.style.left = (toolbarRect.left + window.scrollX) + 'px';
      linkPopover.style.display = 'flex';
      linkInput.value = '';
      linkInput.focus();
    }

    // Step 2: Replace marker with <a> when URL is submitted
    function applyLink(url) {
      linkPopover.style.display = 'none';
      var marker = document.getElementById('link-marker');

      if (!url || !marker) {
        removeMarker();
        contentEditable.focus();
        return;
      }

      // Create anchor and move marker's children into it
      var a = document.createElement('a');
      a.href = url;
      while (marker.firstChild) {
        a.appendChild(marker.firstChild);
      }
      marker.parentNode.replaceChild(a, marker);

      // Place cursor after the new link
      contentEditable.focus();
      var sel = window.getSelection();
      sel.removeAllRanges();
      var newRange = document.createRange();
      newRange.setStartAfter(a);
      newRange.collapse(true);
      sel.addRange(newRange);
    }

    // Cancel: remove marker, restore plain text
    function cancelLinkInput() {
      linkPopover.style.display = 'none';
      removeMarker();
      contentEditable.focus();
    }

    // Link input: Enter to submit, Escape to cancel
    linkInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        applyLink(linkInput.value.trim());
      } else if (e.key === 'Escape') {
        e.preventDefault();
        cancelLinkInput();
      }
    });

    // Submit button
    linkSubmitBtn.addEventListener('mousedown', function(e) {
      e.preventDefault();
    });
    linkSubmitBtn.addEventListener('click', function() {
      applyLink(linkInput.value.trim());
    });

    // Blur: cancel if popover still showing
    linkInput.addEventListener('blur', function() {
      setTimeout(function() {
        if (linkPopover.style.display !== 'none') {
          cancelLinkInput();
        }
      }, 200);
    });

    // Link inspect popover: prevent stealing focus
    if (linkInspectPopover) {
      linkInspectPopover.addEventListener('mousedown', function(e) {
        e.preventDefault();
      });
    }

    // Open link in new tab
    if (linkInspectOpenBtn) {
      linkInspectOpenBtn.addEventListener('click', function() {
        if (inspectedLink) {
          var url = inspectedLink.getAttribute('href');
          if (url) window.open(url, '_blank');
        }
      });
    }

    // Remove link (unwrap <a> tag, keep text)
    if (linkInspectRemoveBtn) {
      linkInspectRemoveBtn.addEventListener('click', function() {
        if (inspectedLink && inspectedLink.parentNode) {
          var parent = inspectedLink.parentNode;
          while (inspectedLink.firstChild) {
            parent.insertBefore(inspectedLink.firstChild, inspectedLink);
          }
          parent.removeChild(inspectedLink);
          parent.normalize();
          hideLinkInspectPopover();
        }
      });
    }

    // Image generation: dispatch event with prompt and slug
    function dispatchImageGenerate(prompt) {
      var article = document.querySelector('.post-article');
      var slug = article ? article.dataset.postSlug : '';
      window.dispatchEvent(new CustomEvent('image-generate-request', {
        detail: { prompt: prompt, slug: slug }
      }));
    }

    // Click handler for existing sketch illustrations - opens modal in edit mode
    // On desktop, fixed-position scroll-reveal images all stack at the same
    // position (only one visible at a time via opacity). The browser routes
    // clicks to the topmost element in DOM order regardless of opacity, so
    // we find the actually-visible image among all .sketch-reveal-active ones.
    contentEditable.addEventListener('click', function(e) {
      var clicked = e.target.closest('.sketch-illustration');
      if (!clicked) return;

      var img = clicked;
      // If this image has scroll-reveal active class, find the visible one instead
      if (clicked.classList.contains('sketch-reveal-active')) {
        var allActive = contentEditable.querySelectorAll('.sketch-illustration.sketch-reveal-active');
        var bestImg = null;
        var bestOpacity = 0;
        for (var i = 0; i < allActive.length; i++) {
          var op = parseFloat(window.getComputedStyle(allActive[i]).opacity);
          if (op > bestOpacity) {
            bestOpacity = op;
            bestImg = allActive[i];
          }
        }
        if (!bestImg || bestOpacity < 0.1) return;
        img = bestImg;
      }

      e.preventDefault();
      e.stopPropagation();
      var article = document.querySelector('.post-article');
      var slug = article ? article.dataset.postSlug : '';
      window.dispatchEvent(new CustomEvent('image-edit-request', {
        detail: {
          imagePath: img.getAttribute('src'),
          imageAlt: img.getAttribute('alt') || '',
          slug: slug,
          imageElement: img
        }
      }));
    });

    // Paste handler for images directly in contenteditable
    contentEditable.addEventListener('paste', function(e) {
      var items = e.clipboardData && e.clipboardData.items;
      if (!items) return;
      for (var i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image/') === 0) {
          e.preventDefault();
          var file = items[i].getAsFile();
          if (!file) return;
          var article = document.querySelector('.post-article');
          var slug = article ? article.dataset.postSlug : '';
          if (!slug) return;
          var formData = new FormData();
          formData.append('file', file);
          formData.append('slug', slug);
          fetch('/api/upload-image', { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(result) {
              if (result.success && result.path) {
                var img = document.createElement('img');
                img.src = result.path;
                img.alt = 'Uploaded image';
                img.className = 'sketch-illustration';
                var wrapper = document.createElement('p');
                wrapper.appendChild(img);
                var sel = window.getSelection();
                if (sel && sel.rangeCount > 0 && contentEditable.contains(sel.anchorNode)) {
                  var node = sel.anchorNode;
                  while (node && node.parentNode !== contentEditable) {
                    node = node.parentNode;
                  }
                  if (node) {
                    node.parentNode.insertBefore(wrapper, node.nextSibling);
                  } else {
                    contentEditable.appendChild(wrapper);
                  }
                } else {
                  contentEditable.appendChild(wrapper);
                }
              }
            });
          return;
        }
      }
    });

    function showImagePromptInput() {
      var toolbarRect = toolbar.getBoundingClientRect();
      imagePromptPopover.style.top = (toolbarRect.bottom + window.scrollY + 4) + 'px';
      imagePromptPopover.style.left = (toolbarRect.left + window.scrollX) + 'px';
      imagePromptPopover.style.display = 'flex';
      imagePromptInput.value = '';
      imagePromptInput.focus();
    }

    function cancelImagePromptInput() {
      imagePromptPopover.style.display = 'none';
      contentEditable.focus();
    }

    function submitImagePrompt(text) {
      imagePromptPopover.style.display = 'none';
      if (text) {
        dispatchImageGenerate(text);
      }
    }

    function handleGenerateImage() {
      var sel = window.getSelection();
      var selectedText = '';
      if (sel && !sel.isCollapsed && contentEditable.contains(sel.anchorNode)) {
        selectedText = sel.toString().trim();
      }
      if (selectedText) {
        dispatchImageGenerate(selectedText);
      } else {
        showImagePromptInput();
      }
    }

    // Image prompt popover events
    if (imagePromptInput) {
      imagePromptInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          submitImagePrompt(imagePromptInput.value.trim());
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelImagePromptInput();
        }
      });

      imagePromptInput.addEventListener('blur', function() {
        setTimeout(function() {
          if (imagePromptPopover.style.display !== 'none') {
            cancelImagePromptInput();
          }
        }, 200);
      });
    }

    if (imagePromptSubmit) {
      imagePromptSubmit.addEventListener('mousedown', function(e) {
        e.preventDefault();
      });
      imagePromptSubmit.addEventListener('click', function() {
        submitImagePrompt(imagePromptInput.value.trim());
      });
    }

    // Handle toolbar button clicks
    toolbar.addEventListener('click', function(e) {
      var button = e.target.closest('button');
      if (!button) return;

      var command = button.getAttribute('data-command');
      var value = button.getAttribute('data-value');

      if (command === 'createLink') {
        showLinkInput();
      } else if (command === 'generateImage') {
        handleGenerateImage();
      } else if (value) {
        document.execCommand(command, false, value);
      } else {
        document.execCommand(command, false, '');
      }

      updateToolbarState(toolbar);
    });

    // Keyboard shortcuts: Ctrl+B, Ctrl+I, Ctrl+K
    document.addEventListener('keydown', function(e) {
      if (!e.ctrlKey && !e.metaKey) return;

      var selection = window.getSelection();
      if (!selection || !contentEditable.contains(selection.anchorNode)) return;

      switch(e.key.toLowerCase()) {
        case 'b':
          e.preventDefault();
          document.execCommand('bold');
          break;
        case 'i':
          e.preventDefault();
          document.execCommand('italic');
          break;
        case 'k':
          e.preventDefault();
          showLinkInput();
          break;
      }

      updateToolbarState(toolbar);
    });
  });

  function updateToolbarState(toolbar) {
    toolbar.querySelectorAll('button').forEach(function(button) {
      var command = button.getAttribute('data-command');
      if (!command) return;
      if (command === 'formatBlock') {
        button.classList.remove('is-active');
        return;
      }
      var isActive = document.queryCommandState(command);
      button.classList.toggle('is-active', isActive);
    });
  }
</script>

<style>
  .edit-toolbar {
    position: absolute;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.2rem;
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    z-index: 1000;
  }

  .edit-toolbar button {
    background: transparent;
    border: none;
    padding: 0.2rem;
    width: 1.4rem;
    height: 1.4rem;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.65rem;
    color: var(--color-text);
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }

  .edit-toolbar button:hover {
    background: var(--color-code-bg);
  }

  .edit-toolbar button.is-active {
    background: #6ba4ff;
    color: white;
  }

  .link-input-popover {
    position: absolute;
    z-index: 1001;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.3rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    display: flex;
    gap: 0.25rem;
    align-items: center;
  }

  #link-submit-btn {
    background: #6ba4ff;
    color: white;
    border: none;
    border-radius: 3px;
    font-size: 0.7rem;
    padding: 0.3rem 0.5rem;
    cursor: pointer;
    white-space: nowrap;
  }

  #link-submit-btn:hover {
    background: #5a93ee;
  }

  .link-input-popover input {
    background: var(--color-code-bg);
    border: 1px solid var(--color-border);
    border-radius: 3px;
    color: var(--color-text);
    font-size: 0.75rem;
    padding: 0.3rem 0.4rem;
    width: 220px;
    outline: none;
  }

  .link-input-popover input:focus {
    border-color: #6ba4ff;
  }

  .link-inspect-popover {
    position: absolute;
    z-index: 1001;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.3rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    display: flex;
    gap: 0.3rem;
    align-items: center;
  }

  .link-inspect-url {
    font-size: 0.7rem;
    color: var(--color-text-light);
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .link-inspect-open-btn {
    background: #6ba4ff;
    color: white;
    border: none;
    border-radius: 3px;
    font-size: 0.65rem;
    padding: 0.2rem 0.4rem;
    cursor: pointer;
    white-space: nowrap;
  }

  .link-inspect-open-btn:hover {
    background: #5a93ee;
  }

  .link-inspect-remove-btn {
    background: transparent;
    color: var(--color-text-light);
    border: none;
    border-radius: 3px;
    font-size: 0.65rem;
    padding: 0.2rem 0.4rem;
    cursor: pointer;
    white-space: nowrap;
  }

  .link-inspect-remove-btn:hover {
    color: var(--color-text);
  }

  .image-prompt-popover {
    position: absolute;
    z-index: 1001;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.3rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    display: flex;
    gap: 0.25rem;
    align-items: center;
  }

  .image-prompt-popover input {
    background: var(--color-code-bg);
    border: 1px solid var(--color-border);
    border-radius: 3px;
    color: var(--color-text);
    font-size: 0.75rem;
    padding: 0.3rem 0.4rem;
    width: 220px;
    outline: none;
  }

  .image-prompt-popover input:focus {
    border-color: #6ba4ff;
  }

  #image-prompt-submit {
    background: #6ba4ff;
    color: white;
    border: none;
    border-radius: 3px;
    font-size: 0.7rem;
    padding: 0.3rem 0.5rem;
    cursor: pointer;
    white-space: nowrap;
  }

  #image-prompt-submit:hover {
    background: #5a93ee;
  }
</style>

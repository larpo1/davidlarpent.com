---
// Floating WYSIWYG toolbar component using execCommand
---

<div id="edit-toolbar" class="edit-toolbar" style="display: none;">
  <button data-command="bold" title="Bold (Ctrl+B)"><strong>B</strong></button>
  <button data-command="italic" title="Italic (Ctrl+I)"><em>I</em></button>
  <button data-command="createLink" title="Add Link (Ctrl+K)">L</button>
  <button data-command="formatBlock" data-value="h2" title="Heading 2">2</button>
  <button data-command="formatBlock" data-value="h3" title="Heading 3">3</button>
  <button data-command="insertUnorderedList" title="Bullet List">â€¢</button>
  <button data-command="formatBlock" data-value="pre" title="Code Block">&lt;&gt;</button>
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const toolbar = document.getElementById('edit-toolbar');
    const contentEditable = document.querySelector('[contenteditable="true"][data-field]');

    if (!toolbar || !contentEditable) return;

    // Show toolbar on text selection
    document.addEventListener('selectionchange', () => {
      const selection = window.getSelection();
      if (!selection || selection.isCollapsed || !contentEditable.contains(selection.anchorNode)) {
        toolbar.style.display = 'none';
        return;
      }

      // Position toolbar to the LEFT of content, inline with selection
      const range = selection.getRangeAt(0);
      const rect = range.getBoundingClientRect();
      const contentRect = contentEditable.getBoundingClientRect();

      toolbar.style.display = 'flex';
      toolbar.style.flexDirection = 'column'; // Vertical stack
      toolbar.style.top = `${rect.top + window.scrollY}px`; // Inline with selection
      toolbar.style.left = `${contentRect.left - 36}px`; // Position in left margin
      toolbar.style.transform = 'translateX(-100%)'; // Push fully left of anchor point

      // Update button active states
      updateToolbarState(toolbar);
    });

    // Handle toolbar button clicks
    toolbar.addEventListener('click', (e) => {
      const button = e.target.closest('button');
      if (!button) return;

      const command = button.getAttribute('data-command');
      const value = button.getAttribute('data-value');

      if (command === 'createLink') {
        const url = prompt('Enter URL:');
        if (url) document.execCommand(command, false, url);
      } else if (value) {
        document.execCommand(command, false, value);
      } else {
        document.execCommand(command, false, '');
      }

      updateToolbarState(toolbar);
    });

    // Keyboard shortcuts: Ctrl+B, Ctrl+I, Ctrl+K
    document.addEventListener('keydown', (e) => {
      if (!e.ctrlKey && !e.metaKey) return;

      // Only apply if focus is in content area
      const selection = window.getSelection();
      if (!selection || !contentEditable.contains(selection.anchorNode)) return;

      switch(e.key.toLowerCase()) {
        case 'b':
          e.preventDefault();
          document.execCommand('bold');
          break;
        case 'i':
          e.preventDefault();
          document.execCommand('italic');
          break;
        case 'k':
          e.preventDefault();
          const url = prompt('Enter URL:');
          if (url) document.execCommand('createLink', false, url);
          break;
      }

      updateToolbarState(toolbar);
    });
  });

  function updateToolbarState(toolbar) {
    toolbar.querySelectorAll('button').forEach(button => {
      const command = button.getAttribute('data-command');
      if (!command) return;

      // formatBlock doesn't have a queryCommandState, so only check simple commands
      if (command === 'formatBlock') {
        button.classList.remove('is-active');
        return;
      }

      const isActive = document.queryCommandState(command);
      button.classList.toggle('is-active', isActive);
    });
  }
</script>

<style>
  .edit-toolbar {
    position: absolute;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.2rem;
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    z-index: 1000;
  }

  .edit-toolbar button {
    background: transparent;
    border: none;
    padding: 0.2rem;
    width: 1.4rem;
    height: 1.4rem;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.65rem;
    color: var(--color-text);
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }

  .edit-toolbar button:hover {
    background: var(--color-code-bg);
  }

  .edit-toolbar button.is-active {
    background: var(--color-link);
    color: white;
  }
</style>

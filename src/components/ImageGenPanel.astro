---
// ImageGenPanel - Full-screen modal for generating sketch illustrations
// 3-column layout: source context | synthesized prompt | image output
// Supports two entry modes:
//   - 'image-generate-request' event: new image creation (Insert)
//   - 'image-edit-request' event: edit/replace existing image (Replace)
// Also supports: gallery browsing, file upload, paste, drag-drop, remove from post
---

<div id="image-gen-modal" class="image-gen-modal" data-open="false">
  <div class="image-gen-modal-backdrop"></div>
  <div class="image-gen-modal-content">
    <div class="image-gen-modal-header">
      <h2 id="image-gen-title">Generate Sketch</h2>
      <button class="image-gen-close-button" title="Close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="image-gen-columns">
      <!-- Left column: Source text + Style prompt -->
      <div class="image-gen-column">
        <label class="image-gen-column-label">Source text</label>
        <div id="image-gen-source" class="image-gen-source-text"></div>

        <label class="image-gen-column-label" style="margin-top: 1rem;">Style prompt</label>
        <textarea id="image-gen-style" class="image-gen-textarea image-gen-style-textarea" rows="6"></textarea>

        <div class="image-gen-column-actions">
          <button id="image-gen-save-style-btn" class="image-gen-secondary-btn" type="button">Save Style</button>
          <button id="image-gen-prompt-btn" class="image-gen-secondary-btn" type="button">Generate Prompt</button>
        </div>
      </div>

      <!-- Middle column: Synthesized prompt -->
      <div class="image-gen-column">
        <label class="image-gen-column-label">Synthesized prompt</label>
        <textarea id="image-gen-prompt" class="image-gen-textarea image-gen-prompt-textarea" placeholder="Click 'Generate Prompt' to synthesize, or type your own..."></textarea>

        <div class="image-gen-column-actions">
          <button id="image-gen-reprompt-btn" class="image-gen-secondary-btn" type="button" style="display: none;">Regenerate Prompt</button>
          <button id="image-gen-image-btn" class="image-gen-primary-btn" type="button" disabled>Generate Image</button>
        </div>
      </div>

      <!-- Right column: Image preview + actions -->
      <div class="image-gen-column">
        <label class="image-gen-column-label">Preview</label>
        <div id="image-gen-preview" class="image-gen-preview">
          <div id="image-gen-loading" class="image-gen-loading" style="display: none;">Generating...</div>
          <img id="image-gen-image" class="image-gen-image" style="display: none;" alt="" />
          <div id="image-gen-placeholder" class="image-gen-preview-placeholder">Image will appear here</div>
        </div>

        <!-- Gallery overlay (hidden by default) -->
        <div id="image-gen-gallery" class="image-gen-gallery" style="display: none;">
          <div class="image-gen-gallery-header">
            <span class="image-gen-column-label">Gallery</span>
            <button id="image-gen-gallery-close" class="image-gen-secondary-btn" type="button" style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">Close</button>
          </div>
          <div id="image-gen-gallery-grid" class="image-gen-gallery-grid"></div>
        </div>

        <div class="image-gen-column-actions">
          <input type="file" id="image-gen-file-input" accept="image/png,image/jpeg,image/webp,image/gif" style="display: none;" />
          <button id="image-gen-upload-btn" class="image-gen-secondary-btn" type="button">Upload</button>
          <button id="image-gen-gallery-btn" class="image-gen-secondary-btn" type="button">Gallery</button>
          <button id="image-gen-remove-btn" class="image-gen-remove-btn" type="button" style="display: none;">Remove from post</button>
          <button id="image-gen-insert" class="image-gen-primary-btn" type="button" disabled>Insert</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', function() {
    var modal = document.getElementById('image-gen-modal');
    var backdrop = modal && modal.querySelector('.image-gen-modal-backdrop');
    var closeBtn = modal && modal.querySelector('.image-gen-close-button');
    var titleEl = document.getElementById('image-gen-title');
    var sourceText = document.getElementById('image-gen-source');
    var styleTextarea = document.getElementById('image-gen-style');
    var promptTextarea = document.getElementById('image-gen-prompt');
    var promptBtn = document.getElementById('image-gen-prompt-btn');
    var saveStyleBtn = document.getElementById('image-gen-save-style-btn');
    var repromptBtn = document.getElementById('image-gen-reprompt-btn');
    var imageBtn = document.getElementById('image-gen-image-btn');
    var insertBtn = document.getElementById('image-gen-insert');
    var loadingEl = document.getElementById('image-gen-loading');
    var imageEl = document.getElementById('image-gen-image');
    var placeholderEl = document.getElementById('image-gen-placeholder');
    var previewEl = document.getElementById('image-gen-preview');
    var contentEditable = document.querySelector('[contenteditable][data-field="content"]');

    // New elements
    var uploadBtn = document.getElementById('image-gen-upload-btn');
    var fileInput = document.getElementById('image-gen-file-input');
    var galleryBtn = document.getElementById('image-gen-gallery-btn');
    var galleryEl = document.getElementById('image-gen-gallery');
    var galleryGrid = document.getElementById('image-gen-gallery-grid');
    var galleryCloseBtn = document.getElementById('image-gen-gallery-close');
    var removeBtn = document.getElementById('image-gen-remove-btn');

    if (!modal || !sourceText || !styleTextarea || !promptTextarea || !promptBtn || !imageBtn || !insertBtn) return;

    var DEFAULT_STYLE = "Square 1:1 aspect ratio. Minimal architectural line drawing on a pure white background. Fine black ink lines only. Clean, precise, spare linework. No shading, no cross-hatching, no fills, no gradients. Just lines on white. Think Dieter Rams sketch meets architectural blueprint. Abstract where possible. Include 1-2 minimal handwritten labels in a loose architect's hand — like notes on a draft, not typeset text. Elegant negative space. The drawing should feel like a diagram that became art.";

    var FEATURE_STYLE = "Wide landscape 1.91:1 aspect ratio (1200x630 pixels). Minimal architectural line drawing on a pure white background. Fine black ink lines only. Clean, precise, spare linework. No shading, no cross-hatching, no fills, no gradients. Just lines on white. Think Dieter Rams sketch meets architectural blueprint. Abstract where possible. Include 1-2 minimal handwritten labels in a loose architect's hand — like notes on a draft, not typeset text. Elegant negative space. The drawing should feel like a diagram that became art. Composition should be horizontally balanced with generous margins on all sides — the image will be used as a social sharing preview.";

    var STYLE_KEY = 'image-gen-style-default';
    var FEATURE_STYLE_KEY = 'image-gen-style-feature';
    var currentStyleKey = STYLE_KEY;

    function getSavedStyle(key, fallback) {
      try { return localStorage.getItem(key) || fallback; }
      catch(e) { return fallback; }
    }

    function saveStyle(key, value) {
      try { localStorage.setItem(key, value); }
      catch(e) { /* ignore */ }
    }

    var currentSlug = '';
    var generatedPath = '';
    var insertAfterEl = null;
    var hasGeneratedPrompt = false;

    // Edit mode state
    var isEditMode = false;
    var editingImage = null; // reference to the DOM <img> being edited
    var referenceImagePath = ''; // path to existing image for edit context

    // Feature image mode state
    var isFeatureMode = false;

    function saveInsertionPoint() {
      var sel = window.getSelection();
      if (sel && sel.rangeCount > 0 && contentEditable && contentEditable.contains(sel.anchorNode)) {
        var node = sel.anchorNode;
        while (node && node.parentNode !== contentEditable) {
          node = node.parentNode;
        }
        insertAfterEl = node || null;
      }
    }

    // Extract just the subject from a full synthesized prompt (after "Subject: ")
    function extractSubject(prompt) {
      var idx = prompt.indexOf('Subject:');
      if (idx !== -1) return prompt.substring(idx + 8).trim();
      return prompt;
    }

    function showPreviewImage(src, alt) {
      generatedPath = src;
      imageEl.src = src.indexOf('data:') === 0 ? src : src + (src.indexOf('?') === -1 ? '?t=' + Date.now() : '');
      imageEl.alt = alt || '';
      imageEl.style.display = 'block';
      loadingEl.style.display = 'none';
      if (placeholderEl) placeholderEl.style.display = 'none';
      insertBtn.disabled = false;
    }

    function resetPreview() {
      imageEl.style.display = 'none';
      imageEl.src = '';
      loadingEl.style.display = 'none';
      loadingEl.textContent = 'Generating...';
      if (placeholderEl) placeholderEl.style.display = '';
      insertBtn.disabled = true;
      generatedPath = '';
    }

    function openModal(prompt, slug) {
      saveInsertionPoint();
      currentSlug = slug || '';
      generatedPath = '';
      hasGeneratedPrompt = false;
      isEditMode = false;
      isFeatureMode = false;
      editingImage = null;
      referenceImagePath = '';

      // Set title and button text for new image mode
      if (titleEl) titleEl.textContent = 'Generate Sketch';
      insertBtn.textContent = 'Insert';
      if (removeBtn) removeBtn.style.display = 'none';

      // Reset left column
      currentStyleKey = STYLE_KEY;
      sourceText.textContent = prompt || '(no text selected)';
      styleTextarea.value = getSavedStyle(STYLE_KEY, DEFAULT_STYLE);

      // Reset middle column
      promptTextarea.value = '';
      promptBtn.textContent = 'Generate Prompt';
      promptBtn.disabled = false;
      promptBtn.style.display = '';
      repromptBtn.style.display = 'none';
      imageBtn.disabled = true;

      // Reset right column
      resetPreview();

      // Hide gallery
      if (galleryEl) galleryEl.style.display = 'none';

      // Open modal
      modal.setAttribute('data-open', 'true');
      document.body.style.overflow = 'hidden';
    }

    function openModalForEdit(imagePath, imageAlt, slug, imageElement) {
      currentSlug = slug || '';
      generatedPath = '';
      hasGeneratedPrompt = false;
      isEditMode = true;
      isFeatureMode = false;
      editingImage = imageElement || null;
      referenceImagePath = imagePath || '';
      insertAfterEl = null;

      // Set title and button text for edit mode
      if (titleEl) titleEl.textContent = 'Edit Sketch';
      insertBtn.textContent = 'Replace';
      if (removeBtn) removeBtn.style.display = '';

      // Left column
      currentStyleKey = STYLE_KEY;
      sourceText.textContent = imageAlt || '(no source text)';
      styleTextarea.value = getSavedStyle(STYLE_KEY, DEFAULT_STYLE);

      // Middle column: restore prompt from data-prompt attr, then localStorage, then alt text
      var savedFullPrompt = '';
      if (imageElement && imageElement.getAttribute('data-prompt')) {
        savedFullPrompt = imageElement.getAttribute('data-prompt');
      }
      if (!savedFullPrompt) {
        try { savedFullPrompt = localStorage.getItem('image-prompt-' + (imagePath || '')) || ''; } catch(e) {}
      }
      promptTextarea.value = savedFullPrompt || imageAlt || '';
      if (savedFullPrompt || imageAlt) {
        // Prompt already exists — show Regenerate, enable Generate Image
        promptBtn.style.display = 'none';
        repromptBtn.style.display = '';
        repromptBtn.disabled = false;
        hasGeneratedPrompt = true;
        imageBtn.disabled = false;
      } else {
        promptBtn.textContent = 'Generate Prompt';
        promptBtn.disabled = false;
        promptBtn.style.display = '';
        repromptBtn.style.display = 'none';
        imageBtn.disabled = true;
      }

      // Right column: show current image
      if (imagePath) {
        showPreviewImage(imagePath, imageAlt);
      } else {
        resetPreview();
      }

      // Hide gallery
      if (galleryEl) galleryEl.style.display = 'none';

      // Open modal
      modal.setAttribute('data-open', 'true');
      document.body.style.overflow = 'hidden';
    }

    function openModalForFeature(slug, postTitle, postDescription, currentImage) {
      currentSlug = slug || '';
      generatedPath = '';
      hasGeneratedPrompt = false;
      isEditMode = false;
      editingImage = null;
      isFeatureMode = true;
      referenceImagePath = currentImage || '';
      insertAfterEl = null;

      // Set title and button text for feature image mode
      if (titleEl) titleEl.textContent = 'Feature Image';
      insertBtn.textContent = 'Set as Feature Image';
      if (removeBtn) removeBtn.style.display = 'none';

      // Left column: title + description as source text
      var sourceContent = postTitle || '';
      if (postDescription) sourceContent += ' — ' + postDescription;
      currentStyleKey = FEATURE_STYLE_KEY;
      sourceText.textContent = sourceContent || '(no title or description)';
      styleTextarea.value = getSavedStyle(FEATURE_STYLE_KEY, FEATURE_STYLE);

      // Middle column: restore saved prompt if available
      var savedPrompt = '';
      try { savedPrompt = localStorage.getItem('feature-image-prompt-' + (slug || '')) || ''; } catch(e) {}
      promptTextarea.value = savedPrompt;
      if (savedPrompt) {
        promptBtn.style.display = 'none';
        repromptBtn.style.display = '';
        repromptBtn.disabled = false;
        hasGeneratedPrompt = true;
        imageBtn.disabled = false;
      } else {
        promptBtn.textContent = 'Generate Prompt';
        promptBtn.disabled = false;
        promptBtn.style.display = '';
        repromptBtn.style.display = 'none';
        imageBtn.disabled = true;
      }

      // Right column: show current image if exists
      if (currentImage) {
        showPreviewImage(currentImage, postTitle);
      } else {
        resetPreview();
      }

      // Hide gallery
      if (galleryEl) galleryEl.style.display = 'none';

      // Open modal
      modal.setAttribute('data-open', 'true');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      modal.setAttribute('data-open', 'false');
      document.body.style.overflow = '';
      generatedPath = '';
      isEditMode = false;
      isFeatureMode = false;
      editingImage = null;
      referenceImagePath = '';
      if (galleryEl) galleryEl.style.display = 'none';
    }

    // Enable Generate Image when prompt textarea has content
    promptTextarea.addEventListener('input', function() {
      imageBtn.disabled = !promptTextarea.value.trim();
    });

    // Generate Prompt via Anthropic
    async function generatePrompt() {
      var source = sourceText.textContent.trim();
      var style = styleTextarea.value.trim();
      if (!source || !style) return;

      promptBtn.disabled = true;
      promptBtn.textContent = 'Generating...';
      if (repromptBtn) {
        repromptBtn.disabled = true;
      }

      try {
        var response = await fetch('/api/generate-image-prompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sourceText: source, stylePrompt: style })
        });

        var result = await response.json();

        if (result.success && result.prompt) {
          promptTextarea.value = result.prompt;
          imageBtn.disabled = false;
          hasGeneratedPrompt = true;
          // Switch to Regenerate Prompt
          promptBtn.style.display = 'none';
          repromptBtn.style.display = '';
          repromptBtn.disabled = false;
        } else {
          promptBtn.textContent = 'Error: ' + (result.message || 'Failed');
          promptBtn.disabled = false;
          if (repromptBtn) repromptBtn.disabled = false;
        }
      } catch (err) {
        promptBtn.textContent = 'Error: ' + err.message;
        promptBtn.disabled = false;
        if (repromptBtn) repromptBtn.disabled = false;
      }
    }

    // Generate Image via Gemini
    async function generateImage() {
      var prompt = promptTextarea.value.trim();
      if (!prompt) return;

      imageBtn.disabled = true;
      imageBtn.textContent = 'Generating...';
      loadingEl.style.display = 'flex';
      imageEl.style.display = 'none';
      if (placeholderEl) placeholderEl.style.display = 'none';
      insertBtn.disabled = true;

      try {
        var response = await fetch('/api/generate-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: prompt, slug: currentSlug, stylePrompt: styleTextarea.value.trim(), referenceImagePath: referenceImagePath || undefined })
        });

        var result = await response.json();

        if (result.success && result.path) {
          generatedPath = result.path;
          imageEl.src = result.dataUrl || (result.path + '?t=' + Date.now());
          imageEl.alt = extractSubject(prompt);
          imageEl.style.display = 'block';
          insertBtn.disabled = false;
        } else {
          loadingEl.textContent = 'Error: ' + (result.message || 'Generation failed');
          imageBtn.disabled = false;
          imageBtn.textContent = 'Generate Image';
          return;
        }
      } catch (err) {
        loadingEl.textContent = 'Error: ' + err.message;
        imageBtn.disabled = false;
        imageBtn.textContent = 'Generate Image';
        return;
      }

      loadingEl.style.display = 'none';
      imageBtn.disabled = false;
      imageBtn.textContent = 'Generate Image';
    }

    function insertImage() {
      if (!generatedPath) { console.error('ImageGen: no generatedPath'); return; }

      var prompt = promptTextarea.value.trim();

      // Feature image mode: save to frontmatter and dispatch event
      if (isFeatureMode) {
        // Persist prompt so it reloads when clicking the feature image again
        try { localStorage.setItem('feature-image-prompt-' + currentSlug, prompt); } catch(e) {}
        fetch('/api/save-post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug: currentSlug, frontmatter: { featureImage: generatedPath } })
        }).then(function(response) {
          return response.json();
        }).then(function(result) {
          if (result.success) {
            window.dispatchEvent(new CustomEvent('feature-image-set', { detail: { path: generatedPath } }));
            closeModal();
          } else {
            console.error('Failed to save feature image:', result.message);
          }
        }).catch(function(err) {
          console.error('Failed to save feature image:', err);
        });
        return;
      }

      if (!contentEditable) {
        contentEditable = document.querySelector('[contenteditable][data-field="content"]') || document.querySelector('[contenteditable][data-field="about"]');
      }

      if (!contentEditable) { console.error('ImageGen: no contentEditable element found'); return; }

      // Persist full prompt so clicking the image reloads it
      if (prompt) {
        try { localStorage.setItem('image-prompt-' + generatedPath, prompt); } catch(e) {}
      }

      if (isEditMode && editingImage) {
        // Replace mode: update existing image src and alt
        editingImage.src = generatedPath;
        if (prompt) editingImage.alt = extractSubject(prompt);
        if (prompt) editingImage.setAttribute('data-prompt', prompt);
        closeModal();
        window.dispatchEvent(new CustomEvent('sketch-reveal-refresh'));
        return;
      }

      // Insert mode: create new image
      var img = document.createElement('img');
      img.src = generatedPath;
      img.alt = extractSubject(prompt);
      img.className = 'sketch-illustration';
      if (prompt) img.setAttribute('data-prompt', prompt);

      var wrapper = document.createElement('p');
      wrapper.appendChild(img);

      if (insertAfterEl && contentEditable.contains(insertAfterEl)) {
        insertAfterEl.parentNode.insertBefore(wrapper, insertAfterEl.nextSibling);
      } else {
        contentEditable.appendChild(wrapper);
      }

      closeModal();
      window.dispatchEvent(new CustomEvent('sketch-reveal-refresh'));
    }

    // Remove image from post (edit mode only)
    function removeFromPost() {
      if (!editingImage) return;
      var parent = editingImage.parentNode;
      if (parent) {
        // If the parent is a <p> that only contains this image, remove the whole <p>
        if (parent.tagName === 'P' && parent.children.length === 1 && parent.children[0] === editingImage) {
          parent.parentNode.removeChild(parent);
        } else {
          parent.removeChild(editingImage);
        }
      }
      closeModal();
      window.dispatchEvent(new CustomEvent('sketch-reveal-refresh'));
    }

    // Upload file handler
    async function handleFileUpload(file) {
      if (!file || !file.type.match(/^image\/(png|jpeg|webp|gif)$/)) return;
      if (!currentSlug) return;

      loadingEl.textContent = 'Uploading...';
      loadingEl.style.display = 'flex';
      imageEl.style.display = 'none';
      if (placeholderEl) placeholderEl.style.display = 'none';
      insertBtn.disabled = true;

      try {
        var formData = new FormData();
        formData.append('file', file);
        formData.append('slug', currentSlug);

        var response = await fetch('/api/upload-image', {
          method: 'POST',
          body: formData
        });

        var result = await response.json();

        if (result.success && result.path) {
          showPreviewImage(result.path, file.name);
        } else {
          loadingEl.textContent = 'Error: ' + (result.message || 'Upload failed');
        }
      } catch (err) {
        loadingEl.textContent = 'Error: ' + err.message;
      }
    }

    // Gallery: load and display images
    async function loadGallery() {
      if (!currentSlug || !galleryGrid || !galleryEl) return;

      galleryGrid.innerHTML = '<div class="image-gen-loading">Loading...</div>';
      galleryEl.style.display = '';

      try {
        var response = await fetch('/api/list-post-images?slug=' + encodeURIComponent(currentSlug));
        var result = await response.json();

        if (result.success && result.images && result.images.length > 0) {
          galleryGrid.innerHTML = '';
          result.images.forEach(function(img) {
            var thumb = document.createElement('div');
            thumb.className = 'image-gen-gallery-thumb';
            thumb.innerHTML = '<img src="' + img.path + '?t=' + Date.now() + '" alt="' + img.filename + '" />';
            thumb.addEventListener('click', function() {
              showPreviewImage(img.path, img.filename);
              galleryEl.style.display = 'none';
            });
            galleryGrid.appendChild(thumb);
          });
        } else {
          galleryGrid.innerHTML = '<div class="image-gen-preview-placeholder">No images found</div>';
        }
      } catch (err) {
        galleryGrid.innerHTML = '<div class="image-gen-preview-placeholder">Error loading gallery</div>';
      }
    }

    // Listen for custom events
    window.addEventListener('image-generate-request', function(e) {
      var detail = e.detail || {};
      openModal(detail.prompt || '', detail.slug || '');
    });

    window.addEventListener('feature-image-request', function(e) {
      var detail = e.detail || {};
      openModalForFeature(
        detail.slug || '',
        detail.title || '',
        detail.description || '',
        detail.currentImage || ''
      );
    });

    window.addEventListener('image-edit-request', function(e) {
      var detail = e.detail || {};
      openModalForEdit(
        detail.imagePath || '',
        detail.imageAlt || '',
        detail.slug || '',
        detail.imageElement || null
      );
    });

    // Button handlers
    promptBtn.addEventListener('click', generatePrompt);
    if (repromptBtn) repromptBtn.addEventListener('click', generatePrompt);
    if (saveStyleBtn) {
      saveStyleBtn.addEventListener('click', function() {
        var value = styleTextarea.value.trim();
        if (!value) return;
        saveStyle(currentStyleKey, value);
        saveStyleBtn.textContent = 'Saved!';
        setTimeout(function() { saveStyleBtn.textContent = 'Save Style'; }, 1500);
      });
    }
    imageBtn.addEventListener('click', generateImage);
    insertBtn.addEventListener('click', insertImage);
    closeBtn.addEventListener('click', closeModal);

    if (removeBtn) {
      removeBtn.addEventListener('click', removeFromPost);
    }

    if (uploadBtn && fileInput) {
      uploadBtn.addEventListener('click', function() {
        fileInput.click();
      });
      fileInput.addEventListener('change', function() {
        if (fileInput.files && fileInput.files[0]) {
          handleFileUpload(fileInput.files[0]);
          fileInput.value = ''; // reset for re-upload
        }
      });
    }

    if (galleryBtn) {
      galleryBtn.addEventListener('click', loadGallery);
    }

    if (galleryCloseBtn && galleryEl) {
      galleryCloseBtn.addEventListener('click', function() {
        galleryEl.style.display = 'none';
      });
    }

    // Backdrop click to close
    backdrop.addEventListener('click', closeModal);

    // Escape to close
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.getAttribute('data-open') === 'true') {
        // Close gallery first if open, then close modal
        if (galleryEl && galleryEl.style.display !== 'none') {
          galleryEl.style.display = 'none';
          return;
        }
        closeModal();
      }
    });

    // Drag-and-drop on preview area
    if (previewEl) {
      previewEl.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        previewEl.classList.add('image-gen-dropzone-active');
      });

      previewEl.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        previewEl.classList.remove('image-gen-dropzone-active');
      });

      previewEl.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        previewEl.classList.remove('image-gen-dropzone-active');
        var files = e.dataTransfer && e.dataTransfer.files;
        if (files && files[0] && files[0].type.match(/^image\//)) {
          handleFileUpload(files[0]);
        }
      });
    }

    // Paste handler on modal (Cmd+V with image)
    modal.addEventListener('paste', function(e) {
      // Don't intercept paste in textareas
      if (e.target.tagName === 'TEXTAREA') return;
      var items = e.clipboardData && e.clipboardData.items;
      if (!items) return;
      for (var i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image/') === 0) {
          e.preventDefault();
          var file = items[i].getAsFile();
          if (file) handleFileUpload(file);
          return;
        }
      }
    });

    // Prevent modal interactions from stealing contenteditable focus
    modal.addEventListener('mousedown', function(e) {
      e.stopPropagation();
    });
  });
</script>

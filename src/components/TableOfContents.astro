---
interface Props {
  headings: Array<{
    depth: number;
    slug: string;
    text: string;
  }>;
  tags?: string[];
}

const { headings, tags = [] } = Astro.props;

// Filter for h2 and h3 headings only
const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);
---

{tocHeadings.length > 0 && (
  <>
    <button id="toc-toggle" class="toc-toggle" aria-label="Toggle table of contents">
      <span class="bar"></span>
      <span class="bar"></span>
      <span class="bar"></span>
    </button>

    <aside id="toc-container" class="toc-container" data-open="false">
      <div class="toc-header">
        <h2>Contents</h2>
      </div>
      <nav class="toc-nav">
        <ul class="toc-list">
          {tocHeadings.map((heading) => (
            <li class={`toc-item toc-depth-${heading.depth}`}>
              <a href={`#${heading.slug}`} class="toc-link" data-slug={heading.slug}>
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </nav>

      {tags.length > 0 && (
        <div class="toc-tags">
          <h3 class="toc-tags-title">Topics</h3>
          <div class="toc-tags-list">
            {tags.map(tag => (
              <a href={`/tags/${tag.toLowerCase()}`} class="toc-tag-link">
                #{tag}
              </a>
            ))}
          </div>
        </div>
      )}
    </aside>
  </>
)}

<script>
  // Toggle functionality
  const toggleButton = document.getElementById('toc-toggle');
  const tocContainer = document.getElementById('toc-container');

  // Check if we're on tablet/mobile (matches CSS breakpoint)
  const isSmallScreen = () => window.innerWidth <= 1024;

  // Get initial state: use localStorage if set, otherwise default based on screen size
  // On desktop (>1024px), default to open; on tablet/mobile, default to closed
  const getInitialState = () => {
    const stored = localStorage.getItem('tocOpen');
    if (stored !== null) {
      return stored === 'true';
    }
    return !isSmallScreen(); // Open on desktop, closed on mobile
  };

  const initialState = getInitialState();

  function setTocState(isOpen: boolean) {
    if (!tocContainer || !toggleButton) return;

    tocContainer.setAttribute('data-open', isOpen.toString());
    toggleButton.classList.toggle('open', isOpen);
    localStorage.setItem('tocOpen', isOpen.toString());
  }

  // Set initial state
  setTocState(initialState);

  // Toggle on click
  toggleButton?.addEventListener('click', () => {
    const isOpen = tocContainer?.getAttribute('data-open') === 'true';
    setTocState(!isOpen);
  });

  // Close TOC on tablet/mobile when clicking a link
  const isMobile = () => window.innerWidth <= 1024;

  document.querySelectorAll('.toc-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const target = (e.currentTarget as HTMLElement).getAttribute('href');

      if (target) {
        // Smooth scroll to section
        const element = document.querySelector(target);
        element?.scrollIntoView({ behavior: 'smooth' });

        // Close TOC on mobile after clicking
        if (isMobile()) {
          setTocState(false);
        }
      }
    });
  });

  // Active section highlighting with Intersection Observer
  const observerOptions = {
    rootMargin: '-20% 0px -35% 0px',
    threshold: 0
  };

  const observerCallback = (entries: IntersectionObserverEntry[]) => {
    entries.forEach(entry => {
      const id = entry.target.getAttribute('id');
      const tocLink = document.querySelector(`.toc-link[data-slug="${id}"]`);

      if (entry.isIntersecting) {
        // Remove active from all links
        document.querySelectorAll('.toc-link').forEach(link => {
          link.classList.remove('active');
        });
        // Add active to current link
        tocLink?.classList.add('active');
      }
    });
  };

  const observer = new IntersectionObserver(observerCallback, observerOptions);

  // Observe all headings
  document.querySelectorAll('h2[id], h3[id]').forEach(heading => {
    observer.observe(heading);
  });
</script>

---
interface Props {
  slug: string;
}

const { slug } = Astro.props;
---

<div class="add-note-panel" id="add-note-panel" style="display: none;" data-slug={slug}>
  <div class="add-note-form">
    <textarea
      class="add-note-textarea"
      id="note-content"
      placeholder="Write your note..."
      rows="4"
    ></textarea>
    <input
      type="text"
      class="add-note-tags-input"
      id="note-tags"
      placeholder="Tags (comma-separated)"
    />
    <input
      type="url"
      class="add-note-spotify-input"
      id="note-spotify"
      placeholder="Spotify link (optional)"
    />
    <div class="add-note-options">
      <label class="add-note-checkbox">
        <input type="checkbox" id="note-published" />
        <span>Published</span>
      </label>
    </div>
    <div class="add-note-actions">
      <button class="add-note-save" id="note-save">Save</button>
      <button class="add-note-cancel" id="note-cancel">Cancel</button>
    </div>
    <div class="add-note-status" id="note-status"></div>
  </div>
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const toggleBtn = document.getElementById('add-note-toggle');
    const panel = document.getElementById('add-note-panel');
    const saveBtn = document.getElementById('note-save');
    const cancelBtn = document.getElementById('note-cancel');
    const statusEl = document.getElementById('note-status');

    if (!toggleBtn || !panel) return;

    toggleBtn.addEventListener('click', () => {
      panel.style.display = panel.style.display === 'none' ? '' : 'none';
      if (panel.style.display !== 'none') {
        document.getElementById('note-content')?.focus();
      }
    });

    cancelBtn?.addEventListener('click', () => {
      panel.style.display = 'none';
      clearForm();
    });

    saveBtn?.addEventListener('click', async () => {
      const content = document.getElementById('note-content')?.value?.trim();
      if (!content) {
        showStatus('Note content is required', true);
        return;
      }

      const slug = panel.dataset.slug;
      const tagsRaw = document.getElementById('note-tags')?.value || '';
      const tags = tagsRaw.split(',').map(t => t.trim()).filter(Boolean);
      const published = document.getElementById('note-published')?.checked || false;
      const spotify = document.getElementById('note-spotify')?.value?.trim() || undefined;

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const resp = await fetch('/api/save-note', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug, content, tags, published, spotify }),
        });

        const data = await resp.json();
        if (data.success) {
          showStatus('Note saved');
          clearForm();
          panel.style.display = 'none';
          // Reload to show the new note
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showStatus(data.message || 'Save failed', true);
        }
      } catch (err) {
        showStatus('Network error', true);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
      }
    });

    function clearForm() {
      const content = document.getElementById('note-content');
      const tags = document.getElementById('note-tags');
      const spotify = document.getElementById('note-spotify');
      const published = document.getElementById('note-published');
      if (content) content.value = '';
      if (tags) tags.value = '';
      if (spotify) spotify.value = '';
      if (published) published.checked = false;
    }

    function showStatus(msg, isError) {
      if (!statusEl) return;
      statusEl.textContent = msg;
      statusEl.style.color = isError ? '#f87171' : 'var(--color-text-light)';
      setTimeout(() => { statusEl.textContent = ''; }, 3000);
    }
  });
</script>

<style>
  .add-note-panel {
    margin: 1rem 0 2rem;
    padding: 1rem;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    background: var(--color-code-bg);
  }

  .add-note-form {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .add-note-textarea {
    width: 100%;
    padding: 0.75rem;
    font-family: inherit;
    font-size: 0.9rem;
    background: var(--color-background);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    resize: vertical;
  }

  .add-note-tags-input,
  .add-note-spotify-input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-family: inherit;
    font-size: 0.85rem;
    background: var(--color-background);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: 4px;
  }

  .add-note-options {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .add-note-checkbox {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.85rem;
    color: var(--color-text-light);
    cursor: pointer;
  }

  .add-note-actions {
    display: flex;
    gap: 0.5rem;
  }

  .add-note-save {
    padding: 0.4rem 1rem;
    background: #6ba4ff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.85rem;
  }

  .add-note-save:hover {
    opacity: 0.9;
  }

  .add-note-save:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .add-note-cancel {
    padding: 0.4rem 1rem;
    background: none;
    color: var(--color-text-light);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.85rem;
  }

  .add-note-cancel:hover {
    border-color: var(--color-link);
  }

  .add-note-status {
    font-size: 0.8rem;
    min-height: 1.2em;
  }
</style>

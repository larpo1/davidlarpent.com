---
// SyndicationModal - Full-screen modal for editing and copying syndication content
// Dev-mode only component. Opened via window.openSyndicationModal(data)
// Side-by-side layout: LinkedIn on left, Substack on right
---

<div id="syndication-modal" class="syndication-modal" data-open="false">
  <div class="syndication-modal-backdrop"></div>
  <div class="syndication-modal-content">
    <div class="syndication-modal-header">
      <h2>Syndicate</h2>
      <button class="syndication-close-button" title="Close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="syndication-columns">
      <div class="syndication-column" data-platform="linkedin">
        <h3 class="syndication-column-label">LinkedIn</h3>
        <textarea class="syndication-textarea" data-platform="linkedin" placeholder="LinkedIn post content..."></textarea>
        <div class="char-count">
          <span class="char-current">0</span>/<span class="char-limit">3000</span>
        </div>
        <div class="hashtag-pills">
          <input class="hashtag-input" placeholder="Add hashtag..." />
        </div>
        <div class="link-preview-card">
          <img class="link-preview-image" src="/og-default.jpg" alt="Link preview" />
          <div class="link-preview-text">
            <div class="link-preview-title"></div>
            <div class="link-preview-url">davidlarpent.com</div>
          </div>
        </div>
        <div class="syndication-column-actions">
          <button class="syndication-regenerate" data-platform="linkedin">Generate</button>
          <button class="syndication-copy-button" data-platform="linkedin">Copy</button>
        </div>
      </div>

      <div class="syndication-column" data-platform="substack">
        <h3 class="syndication-column-label">Substack</h3>
        <textarea class="syndication-textarea" data-platform="substack" placeholder="Substack content..."></textarea>
        <div class="syndication-column-actions">
          <button class="syndication-regenerate" data-platform="substack">Generate</button>
          <button class="syndication-copy-button" data-platform="substack">Copy</button>
        </div>
      </div>
    </div>

    <div class="syndication-status"></div>
  </div>
</div>

<script is:inline>
  (function() {
    var modal = document.getElementById('syndication-modal');
    if (!modal) return;

    var backdrop = modal.querySelector('.syndication-modal-backdrop');
    var closeButton = modal.querySelector('.syndication-close-button');
    var copyButtons = modal.querySelectorAll('.syndication-copy-button');
    var statusEl = modal.querySelector('.syndication-status');
    var linkedinTextarea = modal.querySelector('.syndication-textarea[data-platform="linkedin"]');
    var substackTextarea = modal.querySelector('.syndication-textarea[data-platform="substack"]');
    var charCurrentEl = modal.querySelector('.char-current');
    var charCountContainer = modal.querySelector('.char-count');
    var hashtagPillsContainer = modal.querySelector('.hashtag-pills');
    var hashtagInput = modal.querySelector('.hashtag-input');
    var regenerateButtons = modal.querySelectorAll('.syndication-regenerate');
    var linkPreviewImage = modal.querySelector('.link-preview-image');
    var linkPreviewTitle = modal.querySelector('.link-preview-title');
    var currentSlug = '';
    var generatingPlatforms = {};

    function openModal() {
      modal.setAttribute('data-open', 'true');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      saveToLocalStorage(); // Save both textareas + hashtags on close
      modal.setAttribute('data-open', 'false');
      document.body.style.overflow = '';
      if (statusEl) {
        statusEl.textContent = '';
      }
    }

    function updateCharCount() {
      if (!linkedinTextarea || !charCurrentEl || !charCountContainer) return;
      var len = linkedinTextarea.value.length;
      charCurrentEl.textContent = len;
      if (len > 3000) {
        charCountContainer.classList.add('over-limit');
      } else {
        charCountContainer.classList.remove('over-limit');
      }
    }

    function showStatus(message) {
      if (!statusEl) return;
      statusEl.textContent = message;
      setTimeout(function() {
        if (statusEl.textContent === message) {
          statusEl.textContent = '';
        }
      }, 2000);
    }

    // Update Copy button disabled state based on textarea content
    function updateCopyButtonState() {
      copyButtons.forEach(function(btn) {
        var platform = btn.dataset.platform;
        var textarea = platform === 'linkedin' ? linkedinTextarea : substackTextarea;
        if (textarea) {
          btn.disabled = !textarea.value;
        }
      });
    }

    // Save drafts to localStorage
    function saveToLocalStorage(platform) {
      if (!currentSlug) return;
      try {
        if (!platform || platform === 'linkedin') {
          if (linkedinTextarea) {
            localStorage.setItem('syndication-' + currentSlug + '-linkedin', linkedinTextarea.value);
          }
        }
        if (!platform || platform === 'substack') {
          if (substackTextarea) {
            localStorage.setItem('syndication-' + currentSlug + '-substack', substackTextarea.value);
          }
        }
        // Always save hashtags
        var hashtagData = getHashtagData();
        localStorage.setItem('syndication-' + currentSlug + '-hashtags', JSON.stringify(hashtagData));
      } catch (e) {}
    }

    function getHashtagData() {
      if (!hashtagPillsContainer) return [];
      var pills = hashtagPillsContainer.querySelectorAll('.hashtag-pill');
      var tags = [];
      pills.forEach(function(p) { tags.push(p.dataset.tag); });
      return tags;
    }

    // AI draft generation
    function generateDraft(slug, platform, fallbackText) {
      if (generatingPlatforms[platform]) return;
      generatingPlatforms[platform] = true;

      var textarea = platform === 'linkedin' ? linkedinTextarea : substackTextarea;
      if (!textarea) return;

      // Find the regenerate button for this platform
      var regenBtn = modal.querySelector('.syndication-regenerate[data-platform="' + platform + '"]');

      // Show loading state
      textarea.value = 'Generating draft...';
      textarea.classList.add('loading');
      if (regenBtn) {
        regenBtn.disabled = true;
        regenBtn.textContent = 'Generating...';
      }
      if (statusEl) statusEl.textContent = '';

      fetch('/api/generate-syndication-draft', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug: slug, platform: platform })
      })
      .then(function(response) { return response.json(); })
      .then(function(data) {
        textarea.classList.remove('loading');
        generatingPlatforms[platform] = false;
        if (regenBtn) {
          regenBtn.disabled = false;
          regenBtn.textContent = 'Generate';
        }

        if (data.success) {
          textarea.value = data.draft;
          // Update hashtag pills if LinkedIn and AI returned hashtags
          if (platform === 'linkedin' && data.hashtags && data.hashtags.length > 0) {
            clearPills();
            data.hashtags.forEach(function(tag) { addPill(tag); });
          }
        } else {
          // Fall back to template text
          textarea.value = fallbackText || '';
          showStatus('AI generation failed, using template');
        }
        updateCharCount();
        updateCopyButtonState();
        saveToLocalStorage(platform);
      })
      .catch(function() {
        textarea.classList.remove('loading');
        generatingPlatforms[platform] = false;
        if (regenBtn) {
          regenBtn.disabled = false;
          regenBtn.textContent = 'Generate';
        }
        // Fall back to template text
        textarea.value = fallbackText || '';
        showStatus('AI generation failed, using template');
        updateCharCount();
        updateCopyButtonState();
      });
    }

    // Hashtag pill management
    function createPill(tag) {
      var pill = document.createElement('span');
      pill.className = 'hashtag-pill';
      pill.dataset.tag = tag;

      var text = document.createTextNode('#' + tag);
      pill.appendChild(text);

      var removeBtn = document.createElement('button');
      removeBtn.className = 'hashtag-remove';
      removeBtn.textContent = '\u00D7';
      removeBtn.title = 'Remove';
      removeBtn.addEventListener('click', function() {
        pill.remove();
      });
      pill.appendChild(removeBtn);

      return pill;
    }

    function addPill(tag) {
      if (!hashtagPillsContainer || !tag) return;
      // Normalize: lowercase, strip spaces, remove leading #
      tag = tag.toLowerCase().replace(/\s+/g, '').replace(/^#+/, '');
      if (!tag) return;
      // Don't add duplicates
      var existing = hashtagPillsContainer.querySelectorAll('.hashtag-pill');
      for (var i = 0; i < existing.length; i++) {
        if (existing[i].dataset.tag === tag) return;
      }
      var pill = createPill(tag);
      hashtagPillsContainer.insertBefore(pill, hashtagInput);
    }

    function clearPills() {
      if (!hashtagPillsContainer) return;
      var pills = hashtagPillsContainer.querySelectorAll('.hashtag-pill');
      pills.forEach(function(p) { p.remove(); });
    }

    function getHashtags() {
      if (!hashtagPillsContainer) return [];
      var pills = hashtagPillsContainer.querySelectorAll('.hashtag-pill');
      var tags = [];
      pills.forEach(function(p) { tags.push('#' + p.dataset.tag); });
      return tags;
    }

    // Hashtag input: add pill on Enter
    if (hashtagInput) {
      hashtagInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          addPill(hashtagInput.value);
          hashtagInput.value = '';
        }
      });
    }

    // Character count live update + Copy button state
    if (linkedinTextarea) {
      linkedinTextarea.addEventListener('input', function() { updateCharCount(); updateCopyButtonState(); });
      linkedinTextarea.addEventListener('blur', function() { saveToLocalStorage('linkedin'); });
    }
    if (substackTextarea) {
      substackTextarea.addEventListener('input', function() { updateCopyButtonState(); });
      substackTextarea.addEventListener('blur', function() { saveToLocalStorage('substack'); });
    }

    // Copy buttons (one per column)
    copyButtons.forEach(function(copyButton) {
      copyButton.addEventListener('click', function() {
        var platform = copyButton.dataset.platform;
        var textarea = platform === 'linkedin' ? linkedinTextarea : substackTextarea;
        if (textarea && textarea.value) {
          var textToCopy = textarea.value;
          // Append hashtags for LinkedIn
          if (platform === 'linkedin') {
            var hashtags = getHashtags();
            if (hashtags.length > 0) {
              textToCopy += '\n\n' + hashtags.join(' ');
            }
          }
          saveToLocalStorage(platform);
          navigator.clipboard.writeText(textToCopy).then(function() {
            showStatus('Copied!');
          }).catch(function() {
            showStatus('Failed to copy');
          });
        }
      });
    });

    // Regenerate buttons (one per column)
    regenerateButtons.forEach(function(regenButton) {
      regenButton.addEventListener('click', function() {
        var platform = regenButton.dataset.platform;
        if (!currentSlug || generatingPlatforms[platform]) return;
        var textarea = platform === 'linkedin' ? linkedinTextarea : substackTextarea;
        var fallbackText = textarea ? textarea.value : '';
        generateDraft(currentSlug, platform, fallbackText);
      });
    });

    // Close handlers
    if (closeButton) {
      closeButton.addEventListener('click', closeModal);
    }
    if (backdrop) {
      backdrop.addEventListener('click', closeModal);
    }
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.getAttribute('data-open') === 'true') {
        closeModal();
      }
    });

    // Global function to open the modal
    window.openSyndicationModal = function(data) {
      if (!data) return;

      currentSlug = data.slug || '';

      // Load saved drafts from localStorage, or start empty
      var savedLinkedin = '';
      var savedSubstack = '';
      try {
        savedLinkedin = localStorage.getItem('syndication-' + currentSlug + '-linkedin') || '';
        savedSubstack = localStorage.getItem('syndication-' + currentSlug + '-substack') || '';
      } catch (e) {}

      if (linkedinTextarea) {
        linkedinTextarea.value = savedLinkedin;
      }
      if (substackTextarea) {
        substackTextarea.value = savedSubstack;
      }

      // Populate link preview card
      if (linkPreviewImage) {
        linkPreviewImage.src = data.ogImage || '/og-default.jpg';
      }
      if (linkPreviewTitle) {
        linkPreviewTitle.textContent = data.title || '';
      }

      // Load saved hashtags or populate from tags
      clearPills();
      var savedHashtags = null;
      try {
        var hashtagsJson = localStorage.getItem('syndication-' + currentSlug + '-hashtags');
        if (hashtagsJson) savedHashtags = JSON.parse(hashtagsJson);
      } catch (e) {}

      if (savedHashtags && savedHashtags.length > 0) {
        savedHashtags.forEach(function(tag) { addPill(tag); });
      } else if (data.tags && data.tags.length > 0) {
        data.tags.forEach(function(tag) {
          addPill(tag);
        });
      }

      // Update char count and copy button state
      updateCharCount();
      updateCopyButtonState();

      // Open -- no auto AI generation; user clicks Generate when ready
      openModal();
    };
  })();
</script>

---
// SyndicationModal - Full-screen modal for editing and copying syndication content
// Dev-mode only component. Opened via window.openSyndicationModal(data)
---

<div id="syndication-modal" class="syndication-modal" data-open="false">
  <div class="syndication-modal-backdrop"></div>
  <div class="syndication-modal-content">
    <div class="syndication-modal-header">
      <h2>Syndicate</h2>
      <button class="syndication-close-button" title="Close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="syndication-tab-navigation">
      <button class="syndication-tab-button" data-tab="linkedin" aria-pressed="true">
        LinkedIn
      </button>
      <button class="syndication-tab-button" data-tab="substack" aria-pressed="false">
        Substack
      </button>
      <div class="syndication-tab-underline" aria-hidden="true"></div>
    </div>

    <div class="syndication-tab-panels">
      <div class="syndication-tab-panel" data-panel="linkedin">
        <textarea class="syndication-textarea" data-platform="linkedin" placeholder="LinkedIn post content..."></textarea>
        <div class="char-count">
          <span class="char-current">0</span>/<span class="char-limit">3000</span>
        </div>
        <div class="hashtag-pills">
          <input class="hashtag-input" placeholder="Add hashtag..." />
        </div>
      </div>

      <div class="syndication-tab-panel" data-panel="substack" style="display: none;">
        <textarea class="syndication-textarea" data-platform="substack" placeholder="Substack content..."></textarea>
      </div>
    </div>

    <div class="link-preview-card">
      <img class="link-preview-image" src="/og-default.jpg" alt="Link preview" />
      <div class="link-preview-text">
        <div class="link-preview-title"></div>
        <div class="link-preview-description"></div>
        <div class="link-preview-url">davidlarpent.com</div>
      </div>
    </div>

    <div class="syndication-actions">
      <button class="syndication-regenerate">Regenerate</button>
      <button class="syndication-copy-button">Copy</button>
    </div>

    <div class="syndication-status"></div>
  </div>
</div>

<script is:inline>
  (function() {
    var modal = document.getElementById('syndication-modal');
    if (!modal) return;

    var backdrop = modal.querySelector('.syndication-modal-backdrop');
    var closeButton = modal.querySelector('.syndication-close-button');
    var tabButtons = modal.querySelectorAll('.syndication-tab-button');
    var tabPanels = modal.querySelectorAll('.syndication-tab-panel');
    var tabUnderline = modal.querySelector('.syndication-tab-underline');
    var copyButton = modal.querySelector('.syndication-copy-button');
    var statusEl = modal.querySelector('.syndication-status');
    var linkedinTextarea = modal.querySelector('.syndication-textarea[data-platform="linkedin"]');
    var substackTextarea = modal.querySelector('.syndication-textarea[data-platform="substack"]');
    var charCurrentEl = modal.querySelector('.char-current');
    var charCountContainer = modal.querySelector('.char-count');
    var linkPreviewImage = modal.querySelector('.link-preview-image');
    var linkPreviewTitle = modal.querySelector('.link-preview-title');
    var linkPreviewDescription = modal.querySelector('.link-preview-description');
    var hashtagPillsContainer = modal.querySelector('.hashtag-pills');
    var hashtagInput = modal.querySelector('.hashtag-input');
    var regenerateButton = modal.querySelector('.syndication-regenerate');
    var activeTab = 'linkedin';
    var currentSlug = '';
    var isGenerating = false;

    function openModal() {
      modal.setAttribute('data-open', 'true');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      modal.setAttribute('data-open', 'false');
      document.body.style.overflow = '';
      if (statusEl) {
        statusEl.textContent = '';
      }
    }

    function switchTab(tab) {
      activeTab = tab;
      tabButtons.forEach(function(btn) {
        btn.setAttribute('aria-pressed', (btn.dataset.tab === tab).toString());
      });
      tabPanels.forEach(function(panel) {
        panel.style.display = panel.dataset.panel === tab ? '' : 'none';
      });
      updateTabUnderline();
    }

    function updateTabUnderline() {
      var activeButton = modal.querySelector('.syndication-tab-button[aria-pressed="true"]');
      if (activeButton && tabUnderline) {
        var buttonRect = activeButton.getBoundingClientRect();
        var containerRect = activeButton.parentElement.getBoundingClientRect();
        var offsetLeft = buttonRect.left - containerRect.left;
        tabUnderline.style.transform = 'translateX(' + offsetLeft + 'px)';
        tabUnderline.style.width = buttonRect.width + 'px';
      }
    }

    function updateCharCount() {
      if (!linkedinTextarea || !charCurrentEl || !charCountContainer) return;
      var len = linkedinTextarea.value.length;
      charCurrentEl.textContent = len;
      if (len > 3000) {
        charCountContainer.classList.add('over-limit');
      } else {
        charCountContainer.classList.remove('over-limit');
      }
    }

    function showStatus(message) {
      if (!statusEl) return;
      statusEl.textContent = message;
      setTimeout(function() {
        if (statusEl.textContent === message) {
          statusEl.textContent = '';
        }
      }, 2000);
    }

    // AI draft generation
    function generateDraft(slug, platform, fallbackText) {
      if (isGenerating) return;
      isGenerating = true;

      var textarea = platform === 'linkedin' ? linkedinTextarea : substackTextarea;
      if (!textarea) return;

      // Show loading state
      textarea.value = 'Generating draft...';
      textarea.classList.add('loading');
      if (regenerateButton) regenerateButton.disabled = true;
      if (statusEl) statusEl.textContent = '';

      fetch('/api/generate-syndication-draft', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug: slug, platform: platform })
      })
      .then(function(response) { return response.json(); })
      .then(function(data) {
        textarea.classList.remove('loading');
        isGenerating = false;
        if (regenerateButton) regenerateButton.disabled = false;

        if (data.success) {
          textarea.value = data.draft;
          // Update hashtag pills if LinkedIn and AI returned hashtags
          if (platform === 'linkedin' && data.hashtags && data.hashtags.length > 0) {
            clearPills();
            data.hashtags.forEach(function(tag) { addPill(tag); });
          }
        } else {
          // Fall back to template text
          textarea.value = fallbackText || '';
          showStatus('AI generation failed, using template');
        }
        updateCharCount();
      })
      .catch(function() {
        textarea.classList.remove('loading');
        isGenerating = false;
        if (regenerateButton) regenerateButton.disabled = false;
        // Fall back to template text
        textarea.value = fallbackText || '';
        showStatus('AI generation failed, using template');
        updateCharCount();
      });
    }

    // Hashtag pill management
    function createPill(tag) {
      var pill = document.createElement('span');
      pill.className = 'hashtag-pill';
      pill.dataset.tag = tag;

      var text = document.createTextNode('#' + tag);
      pill.appendChild(text);

      var removeBtn = document.createElement('button');
      removeBtn.className = 'hashtag-remove';
      removeBtn.textContent = '\u00D7';
      removeBtn.title = 'Remove';
      removeBtn.addEventListener('click', function() {
        pill.remove();
      });
      pill.appendChild(removeBtn);

      return pill;
    }

    function addPill(tag) {
      if (!hashtagPillsContainer || !tag) return;
      // Normalize: lowercase, strip spaces, remove leading #
      tag = tag.toLowerCase().replace(/\s+/g, '').replace(/^#+/, '');
      if (!tag) return;
      // Don't add duplicates
      var existing = hashtagPillsContainer.querySelectorAll('.hashtag-pill');
      for (var i = 0; i < existing.length; i++) {
        if (existing[i].dataset.tag === tag) return;
      }
      var pill = createPill(tag);
      hashtagPillsContainer.insertBefore(pill, hashtagInput);
    }

    function clearPills() {
      if (!hashtagPillsContainer) return;
      var pills = hashtagPillsContainer.querySelectorAll('.hashtag-pill');
      pills.forEach(function(p) { p.remove(); });
    }

    function getHashtags() {
      if (!hashtagPillsContainer) return [];
      var pills = hashtagPillsContainer.querySelectorAll('.hashtag-pill');
      var tags = [];
      pills.forEach(function(p) { tags.push('#' + p.dataset.tag); });
      return tags;
    }

    // Hashtag input: add pill on Enter
    if (hashtagInput) {
      hashtagInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          addPill(hashtagInput.value);
          hashtagInput.value = '';
        }
      });
    }

    // Tab click handlers
    tabButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var tab = btn.dataset.tab;
        switchTab(tab);
        // If switching tabs and the other tab's textarea is empty, trigger generation
        var textarea = tab === 'linkedin' ? linkedinTextarea : substackTextarea;
        if (textarea && !textarea.value && currentSlug && !isGenerating) {
          generateDraft(currentSlug, tab, '');
        }
      });
    });

    // Character count live update
    if (linkedinTextarea) {
      linkedinTextarea.addEventListener('input', updateCharCount);
    }

    // Copy button
    if (copyButton) {
      copyButton.addEventListener('click', function() {
        var textarea = activeTab === 'linkedin' ? linkedinTextarea : substackTextarea;
        if (textarea && textarea.value) {
          var textToCopy = textarea.value;
          // Append hashtags for LinkedIn
          if (activeTab === 'linkedin') {
            var hashtags = getHashtags();
            if (hashtags.length > 0) {
              textToCopy += '\n\n' + hashtags.join(' ');
            }
          }
          navigator.clipboard.writeText(textToCopy).then(function() {
            showStatus('Copied!');
          }).catch(function() {
            showStatus('Failed to copy');
          });
        }
      });
    }

    // Regenerate button
    if (regenerateButton) {
      regenerateButton.addEventListener('click', function() {
        if (!currentSlug || isGenerating) return;
        var textarea = activeTab === 'linkedin' ? linkedinTextarea : substackTextarea;
        var fallbackText = textarea ? textarea.value : '';
        generateDraft(currentSlug, activeTab, fallbackText);
      });
    }

    // Close handlers
    if (closeButton) {
      closeButton.addEventListener('click', closeModal);
    }
    if (backdrop) {
      backdrop.addEventListener('click', closeModal);
    }
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.getAttribute('data-open') === 'true') {
        closeModal();
      }
    });

    // Global function to open the modal
    window.openSyndicationModal = function(data) {
      if (!data) return;

      currentSlug = data.slug || '';

      // Store fallback texts
      var linkedinFallback = data.linkedinText || '';
      var substackFallback = data.substackText || '';

      // Set fallback texts initially (will be replaced by AI if available)
      if (linkedinTextarea) {
        linkedinTextarea.value = linkedinFallback;
      }
      if (substackTextarea) {
        substackTextarea.value = substackFallback;
      }

      // Populate hashtag pills from tags
      clearPills();
      if (data.tags && data.tags.length > 0) {
        data.tags.forEach(function(tag) {
          addPill(tag);
        });
      }

      // Populate link preview card
      if (linkPreviewImage) {
        linkPreviewImage.src = data.ogImage || '/og-default.jpg';
      }
      if (linkPreviewTitle) {
        linkPreviewTitle.textContent = data.title || '';
      }
      if (linkPreviewDescription) {
        var desc = data.description || '';
        linkPreviewDescription.textContent = desc.length > 120 ? desc.substring(0, 120) + '...' : desc;
      }

      // Switch to requested platform tab
      var platform = data.platform || 'linkedin';
      switchTab(platform);

      // Update char count
      updateCharCount();

      // Open
      openModal();

      // Update underline position after modal is visible
      requestAnimationFrame(function() {
        updateTabUnderline();
      });

      // Trigger AI draft generation for the active platform
      if (currentSlug) {
        var fallback = platform === 'linkedin' ? linkedinFallback : substackFallback;
        generateDraft(currentSlug, platform, fallback);
      }
    };

    // Initialize underline on load
    requestAnimationFrame(function() {
      updateTabUnderline();
    });
  })();
</script>

---
interface Props {
  slug: string;
  archived: boolean;
}

const { slug, archived } = Astro.props;
---

<div id="source-settings-modal" class="source-settings-modal" data-open="false">
  <div class="source-settings-backdrop"></div>
  <div class="source-settings-content">
    <div class="source-settings-group">
      <label class="publish-toggle source-archive-toggle">
        <input type="checkbox" id="source-archived" checked={!archived} />
        <span class="publish-toggle-slider"></span>
        <span class="publish-toggle-text">{archived ? 'archived' : 'active'}</span>
      </label>
    </div>

    <div class="source-settings-actions">
      <button type="button" class="source-settings-cancel">Cancel</button>
      <button type="button" class="source-settings-save" id="source-save-btn">Save</button>
    </div>

    <span class="source-settings-status" id="source-save-status"></span>
  </div>
</div>

<style>
  .source-settings-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 200;
    pointer-events: none;
  }

  .source-settings-modal[data-open="true"] {
    pointer-events: auto;
  }

  .source-settings-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
  }

  .source-settings-modal[data-open="true"] .source-settings-backdrop {
    opacity: 1;
  }

  .source-settings-content {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 280px;
    max-width: 90vw;
    height: 100%;
    overflow-y: auto;
    background: var(--color-background);
    border-left: 1px solid var(--color-border);
    padding: 1.5rem;
    transform: translateX(100%);
    transition: transform 0.2s ease-in-out;
    font-size: 0.9rem;
  }

  .source-settings-modal[data-open="true"] .source-settings-content {
    transform: translateX(0);
  }

  .source-settings-group {
    margin-bottom: 1.25rem;
  }

  .source-settings-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }

  .source-settings-cancel,
  .source-settings-save {
    padding: 0.4rem 0.9rem;
    font-size: 0.85rem;
    font-family: inherit;
    border-radius: 4px;
    cursor: pointer;
    border: none;
  }

  .source-settings-cancel {
    background: var(--color-code-bg);
    color: var(--color-text-light);
    border: 1px solid var(--color-border);
  }

  .source-settings-cancel:hover {
    background: var(--color-border);
  }

  .source-settings-save {
    background: #6ba4ff;
    color: white;
  }

  .source-settings-save:hover {
    background: #5a93ee;
  }

  .source-settings-status {
    display: block;
    margin-top: 1rem;
    font-size: 0.85rem;
    text-align: center;
  }

  .source-settings-status.error {
    color: #f87171;
  }

  .source-settings-status.success {
    color: #4ade80;
  }
</style>

<script define:vars={{ sourceSlug: slug }}>
  const modal = document.getElementById('source-settings-modal');
  const backdrop = modal?.querySelector('.source-settings-backdrop');
  const cancelButton = modal?.querySelector('.source-settings-cancel');
  const statusEl = modal?.querySelector('.source-settings-status');

  function openSourceSettings() {
    modal?.setAttribute('data-open', 'true');
  }

  function closeSourceSettings() {
    modal?.setAttribute('data-open', 'false');
    if (statusEl) {
      statusEl.textContent = '';
      statusEl.className = 'source-settings-status';
    }
  }

  // Expose globally so the gear button can call it
  window.openSourceSettings = openSourceSettings;

  backdrop?.addEventListener('click', closeSourceSettings);
  cancelButton?.addEventListener('click', closeSourceSettings);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.getAttribute('data-open') === 'true') {
      closeSourceSettings();
    }
  });

  // Archive toggle
  document.getElementById('source-archived')?.addEventListener('change', async (e) => {
    const isActive = e.target.checked;
    const label = e.target.closest('.publish-toggle').querySelector('.publish-toggle-text');
    try {
      const res = await fetch('/api/save-source', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug: sourceSlug, archived: !isActive }),
      });
      const data = await res.json();
      if (data.success) {
        label.textContent = isActive ? 'active' : 'archived';
        document.querySelector('.source-detail').classList.toggle('source-archived', !isActive);
      } else {
        e.target.checked = !e.target.checked;
      }
    } catch {
      e.target.checked = !e.target.checked;
    }
  });

  // Metadata save
  async function saveMetadata() {
    const btn = document.getElementById('source-save-btn');
    btn.disabled = true;
    statusEl.textContent = 'Saving...';
    statusEl.className = 'source-settings-status';

    const title = document.getElementById('source-title').textContent.trim();
    const author = document.getElementById('source-author').textContent.trim();
    const type = document.getElementById('source-type').textContent.trim();
    const link = document.getElementById('source-link')?.textContent.trim() || '';
    const date = document.getElementById('source-date').value;

    try {
      const res = await fetch('/api/save-source', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          slug: sourceSlug,
          title,
          author,
          type,
          link: link || undefined,
          date,
        }),
      });
      const data = await res.json();
      if (data.success) {
        statusEl.textContent = 'Saved';
        statusEl.className = 'source-settings-status success';
        setTimeout(() => { statusEl.textContent = ''; statusEl.className = 'source-settings-status'; }, 2000);
      } else {
        statusEl.textContent = data.message;
        statusEl.className = 'source-settings-status error';
      }
    } catch (err) {
      statusEl.textContent = 'Error saving';
      statusEl.className = 'source-settings-status error';
    }
    btn.disabled = false;
  }

  document.getElementById('source-save-btn')?.addEventListener('click', saveMetadata);

  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 's') {
      e.preventDefault();
      saveMetadata();
    }
  });
</script>

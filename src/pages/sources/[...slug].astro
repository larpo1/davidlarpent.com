---
import { getCollection } from 'astro:content';
import * as fs from 'fs/promises';
import * as path from 'path';
import matter from 'gray-matter';
import Base from '../../layouts/Base.astro';
import AddNotePanel from '../../components/AddNotePanel.astro';
import SourceSettingsPanel from '../../components/SourceSettingsPanel.astro';
import { parseNotes } from '../../lib/parse-notes';

const isDev = import.meta.env.DEV;

export async function getStaticPaths() {
  const allSources = await getCollection('sources');
  return allSources.map(source => ({
    params: { slug: source.slug },
    props: { source },
  }));
}

const { source } = Astro.props;

// Read raw markdown to parse notes
const sourcesDir = path.join(process.cwd(), 'src', 'content', 'sources');
const filePath = path.join(sourcesDir, `${source.slug}.md`);
const rawContent = await fs.readFile(filePath, 'utf-8');
const parsed = matter(rawContent);
const allNotes = parseNotes(parsed.content);

// In production, only show published notes
const notes = isDev ? allNotes : allNotes.filter(n => n.published);

const formattedDate = source.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'short',
  day: 'numeric'
});

const isoDate = source.data.date.toISOString().split('T')[0];
const isArchived = source.data.archived ?? false;
const sourceTypes = ['book', 'article', 'paper', 'podcast'];
---

<Base
  title={`${source.data.title} | David Larpent`}
  description={`Notes on ${source.data.title} by ${source.data.author}`}
>
  <div class:list={['source-detail', { 'source-archived': isArchived }]}>
    <header class="source-header">
      <span
        class:list={['source-type-badge', { 'source-type-editable': isDev }]}
        id="source-type"
        data-types={JSON.stringify(sourceTypes)}
      >{source.data.type}</span>

      <h1 class="source-title" contenteditable={isDev ? 'true' : undefined} id="source-title">{source.data.title}</h1>

      <p class="source-author-line">
        {isDev ? (
          <span contenteditable="true" id="source-author">{source.data.author}</span>
        ) : (
          <Fragment>{source.data.author}</Fragment>
        )}
        &middot;
        <span class:list={['source-date-display', { 'source-date-editable': isDev }]} id="source-date-display">{formattedDate}</span>
        {isDev && <input type="date" class="source-date-hidden" id="source-date" value={isoDate} />}
      </p>

      {(source.data.link || isDev) && (
        <div class="source-link-wrapper">
          <a href={source.data.link || '#'} class="source-link" id="source-link-anchor" target="_blank" rel="noopener noreferrer">
            View source &rarr;
          </a>
          {isDev && (
            <span contenteditable="true" class="source-link-url" id="source-link">{source.data.link || ''}</span>
          )}
        </div>
      )}

      <div class="post-tags source-tags-container" style="margin-top: 0.75rem;">
        {source.data.tags.map(tag => (
          <span class="tag-link source-tag-pill">
            #{tag}
            {isDev && <button class="source-tag-remove" data-tag={tag}>&times;</button>}
          </span>
        ))}
        {isDev && (
          <input class="source-tag-input" id="source-tag-input" placeholder="Add tag..." />
        )}
      </div>

      {isDev && (
        <button class="source-settings-button" id="source-settings-button" title="Source settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
          </svg>
        </button>
      )}
    </header>

    <div class="notes-list">
      {notes.length === 0 && (
        <p class="empty-notes">
          {isDev ? 'No notes yet.' : 'No published notes yet.'}
        </p>
      )}

      {notes.map(note => (
        <div class:list={['note-card', { 'note-draft': !note.published }]} data-timestamp={note.timestamp}>
          <div class="note-meta">
            <time>{new Date(note.timestamp).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</time>
            {isDev && (
              <label class="publish-toggle">
                <input type="checkbox" class="note-publish-checkbox" checked={note.published} />
                <span class="publish-toggle-slider"></span>
                <span class="publish-toggle-text">{note.published ? 'published' : 'private'}</span>
              </label>
            )}
            {isDev && (
              <button class="note-delete-btn">Delete</button>
            )}
            {note.spotify && (
              <a href={note.spotify} class="spotify-link" target="_blank" rel="noopener noreferrer">
                Spotify &rarr;
              </a>
            )}
          </div>
          {note.tags.length > 0 && (
            <div class="note-tags">
              {note.tags.map(tag => (
                <a href={`/tags/${tag.toLowerCase()}`} class="tag-link">
                  #{tag}
                </a>
              ))}
            </div>
          )}
          <div class="note-content">
            <p contenteditable={isDev ? 'true' : undefined} class={isDev ? 'note-editable' : ''}>{note.content}</p>
          </div>
        </div>
      ))}
    </div>

    {isDev && (
      <button class="add-note-button" id="add-note-toggle">+ Add note</button>
    )}

    {isDev && <AddNotePanel slug={source.slug} />}
    {isDev && <SourceSettingsPanel slug={source.slug} archived={isArchived} />}

    <a href="/?tab=input" class="back-link">&larr; Back to sources</a>
  </div>

  {isDev && (
    <script define:vars={{ sourceSlug: source.slug, initialTags: source.data.tags }}>
      // --- Type badge click-to-cycle ---
      const typeBadge = document.getElementById('source-type');
      if (typeBadge) {
        const types = JSON.parse(typeBadge.dataset.types);
        typeBadge.addEventListener('click', () => {
          const current = typeBadge.textContent.trim();
          const idx = types.indexOf(current);
          const next = types[(idx + 1) % types.length];
          typeBadge.textContent = next;
        });
      }

      // --- Date display click-to-pick ---
      const dateDisplay = document.getElementById('source-date-display');
      const dateInput = document.getElementById('source-date');
      if (dateDisplay && dateInput) {
        dateDisplay.addEventListener('click', () => {
          dateInput.showPicker();
        });
        dateInput.addEventListener('change', () => {
          const [y, m, d] = dateInput.value.split('-');
          const dt = new Date(Number(y), Number(m) - 1, Number(d));
          dateDisplay.textContent = dt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        });
      }

      // --- Link URL sync ---
      const linkUrl = document.getElementById('source-link');
      const linkAnchor = document.getElementById('source-link-anchor');
      if (linkUrl && linkAnchor) {
        linkUrl.addEventListener('blur', () => {
          const url = linkUrl.textContent.trim();
          if (url) {
            linkAnchor.href = url;
            linkAnchor.style.display = '';
          } else {
            linkAnchor.style.display = 'none';
          }
        });
      }

      // --- Tag management ---
      let currentTags = [...initialTags];

      function renderTags() {
        const container = document.querySelector('.source-tags-container');
        const input = document.getElementById('source-tag-input');
        // Remove existing tag pills (but keep the input)
        container.querySelectorAll('.source-tag-pill').forEach(el => el.remove());
        // Insert pills before the input using safe DOM methods
        currentTags.forEach(tag => {
          const pill = document.createElement('span');
          pill.className = 'tag-link source-tag-pill';
          pill.textContent = '#' + tag;

          const removeBtn = document.createElement('button');
          removeBtn.className = 'source-tag-remove';
          removeBtn.dataset.tag = tag;
          removeBtn.textContent = '\u00d7';
          pill.appendChild(removeBtn);

          container.insertBefore(pill, input);
        });
      }

      document.querySelector('.source-tags-container')?.addEventListener('click', (e) => {
        const btn = e.target.closest('.source-tag-remove');
        if (!btn) return;
        const tag = btn.dataset.tag;
        currentTags = currentTags.filter(t => t !== tag);
        renderTags();
      });

      document.getElementById('source-tag-input')?.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter') return;
        e.preventDefault();
        const val = e.target.value.trim().toLowerCase().replace(/^#/, '');
        if (val && !currentTags.includes(val)) {
          currentTags.push(val);
          renderTags();
        }
        e.target.value = '';
      });

      // --- Gear button opens settings panel ---
      document.getElementById('source-settings-button')?.addEventListener('click', () => {
        window.openSourceSettings?.();
      });

      // --- Note content editing (blur-to-save) ---
      document.querySelectorAll('.note-editable').forEach(el => {
        const original = el.textContent;
        el.addEventListener('blur', async () => {
          const newContent = el.textContent.trim();
          if (newContent === original.trim()) return;

          const card = el.closest('.note-card');
          const timestamp = card.dataset.timestamp;

          try {
            const res = await fetch('/api/save-source', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ slug: sourceSlug, timestamp, content: newContent }),
            });
            const data = await res.json();
            if (!data.success) {
              console.error('Failed to save note:', data.message);
            }
          } catch (err) {
            console.error('Failed to save note:', err);
          }
        });
      });

      // --- Note publish toggle ---
      document.querySelector('.notes-list')?.addEventListener('change', async (e) => {
        const checkbox = e.target;
        if (!checkbox.classList.contains('note-publish-checkbox')) return;

        const card = checkbox.closest('.note-card');
        const timestamp = card.dataset.timestamp;
        const label = checkbox.closest('.publish-toggle').querySelector('.publish-toggle-text');

        try {
          const res = await fetch('/api/update-note', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ slug: sourceSlug, timestamp, action: 'toggle-published' }),
          });
          const data = await res.json();
          if (data.success) {
            const isPublished = checkbox.checked;
            label.textContent = isPublished ? 'published' : 'private';
            card.classList.toggle('note-draft', !isPublished);
          } else {
            checkbox.checked = !checkbox.checked;
          }
        } catch {
          checkbox.checked = !checkbox.checked;
        }
      });

      // --- Note delete ---
      document.querySelector('.notes-list')?.addEventListener('click', async (e) => {
        const btn = e.target;
        if (!btn.classList.contains('note-delete-btn')) return;

        if (!window.confirm('Delete this note?')) return;

        const card = btn.closest('.note-card');
        const timestamp = card.dataset.timestamp;

        try {
          const res = await fetch('/api/update-note', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ slug: sourceSlug, timestamp, action: 'delete' }),
          });
          const data = await res.json();
          if (data.success) {
            card.remove();
          }
        } catch (err) {
          console.error('Failed to delete note:', err);
        }
      });
    </script>
  )}
</Base>

<style>
  .source-detail {
    max-width: var(--max-width);
  }

  .source-archived {
    opacity: 0.5;
  }

  .source-header {
    position: relative;
    margin-bottom: 2.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .source-settings-button {
    position: absolute;
    top: 0;
    right: 0;
    background: none;
    border: none;
    color: var(--color-text-light);
    cursor: pointer;
    padding: 0.25rem;
    opacity: 0.4;
    transition: opacity 0.2s;
  }

  .source-settings-button:hover {
    opacity: 1;
    color: var(--color-link);
  }

  .source-title {
    font-size: 2rem;
    margin: 0.5rem 0 0.25rem;
    line-height: 1.3;
  }

  .source-title[contenteditable="true"] {
    outline: none;
    border-bottom: 1px dashed var(--color-border);
  }

  .source-title[contenteditable="true"]:focus {
    border-bottom-color: var(--color-link);
  }

  .source-author-line {
    color: var(--color-text-light);
    font-style: italic;
    margin: 0;
  }

  #source-author[contenteditable="true"] {
    outline: none;
    border-bottom: 1px dashed var(--color-border);
  }

  #source-author[contenteditable="true"]:focus {
    border-bottom-color: var(--color-link);
  }

  .source-type-editable {
    cursor: pointer;
  }

  .source-type-editable:hover {
    border-color: var(--color-link);
  }

  .source-date-display {
    /* matches italic author line */
  }

  .source-date-editable {
    cursor: pointer;
    border-bottom: 1px dashed transparent;
  }

  .source-date-editable:hover {
    border-bottom-color: var(--color-border);
  }

  .source-date-hidden {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
    pointer-events: none;
  }

  .source-link-wrapper {
    margin-top: 0.5rem;
  }

  .source-link {
    display: inline-block;
    font-size: 0.85rem;
    color: var(--color-text-light);
    text-decoration: none;
  }

  .source-link:hover {
    color: var(--color-link-hover);
  }

  .source-link-url {
    display: block;
    font-size: 0.75rem;
    color: var(--color-text-light);
    opacity: 0.5;
    margin-top: 0.25rem;
    outline: none;
    border-bottom: 1px dashed transparent;
    word-break: break-all;
  }

  .source-link-url:hover {
    opacity: 0.8;
    border-bottom-color: var(--color-border);
  }

  .source-link-url:focus {
    opacity: 1;
    border-bottom-color: var(--color-link);
  }

  .source-tags-container {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
  }

  .source-tag-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .source-tag-remove {
    background: none;
    border: none;
    color: var(--color-text-light);
    cursor: pointer;
    font-size: 0.9rem;
    padding: 0;
    line-height: 1;
    opacity: 0.5;
  }

  .source-tag-remove:hover {
    color: #f87171;
    opacity: 1;
  }

  .source-tag-input {
    font-family: inherit;
    font-size: 0.8rem;
    background: none;
    color: var(--color-text-light);
    border: 1px dashed var(--color-border);
    border-radius: 2rem;
    padding: 0.2em 0.6em;
    width: 100px;
  }

  .source-tag-input:focus {
    outline: none;
    border-color: var(--color-link);
  }


  .notes-list {
    margin-bottom: 2rem;
  }

  .note-card {
    padding: 1.25rem 0;
    border-bottom: 1px solid var(--color-border);
  }

  .note-draft {
    opacity: 0.5;
  }

  .note-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.75rem;
    color: var(--color-text-light);
    margin-bottom: 0.5rem;
  }

  .note-delete-btn {
    background: none;
    border: none;
    color: var(--color-text-light);
    font-size: 0.7rem;
    cursor: pointer;
    padding: 0;
    font-family: inherit;
    opacity: 0.5;
  }

  .note-delete-btn:hover {
    color: #f87171;
    opacity: 1;
  }

  .note-tags {
    margin-bottom: 0.5rem;
  }

  .note-content p {
    margin: 0;
    line-height: 1.6;
  }

  .note-editable {
    outline: none;
    border-bottom: 1px dashed transparent;
    transition: border-color 0.2s;
  }

  .note-editable:focus {
    border-bottom-color: var(--color-link);
  }

  .spotify-link {
    font-size: 0.75rem;
    color: #1db954;
    text-decoration: none;
  }

  .spotify-link:hover {
    text-decoration: underline;
  }

  .add-note-button {
    display: block;
    margin: 1.5rem 0;
    padding: 0.5rem 1rem;
    background: none;
    border: 1px dashed var(--color-border);
    border-radius: 4px;
    color: var(--color-text-light);
    cursor: pointer;
    font-family: inherit;
    font-size: 0.85rem;
  }

  .add-note-button:hover {
    border-color: var(--color-link);
    color: var(--color-link);
  }

  .empty-notes {
    color: var(--color-text-light);
    font-style: italic;
    padding: 2rem 0;
  }

  .back-link {
    display: inline-block;
    margin-top: 2rem;
    color: var(--color-text-light);
    text-decoration: none;
    font-size: 0.9rem;
  }

  .back-link:hover {
    color: var(--color-link-hover);
  }
</style>

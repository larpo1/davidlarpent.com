---
import { getCollection } from 'astro:content';
import Post from '../../layouts/Post.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts');

  // In dev: show all posts (including drafts). In prod: only published.
  const visiblePosts = import.meta.env.DEV
    ? allPosts
    : allPosts.filter(post => !post.data.draft);

  return visiblePosts.map(post => {
    // Find related posts (posts with at least one shared tag)
    // Related posts should only link to posts visible in current env
    const relatedPosts = visiblePosts
      .filter(p => p.slug !== post.slug) // Exclude current post
      .filter(p => p.data.tags.some(tag => post.data.tags.includes(tag))) // Has shared tag
      .map(p => ({
        slug: p.slug,
        title: p.data.title,
        description: p.data.description,
        sharedTags: p.data.tags.filter(tag => post.data.tags.includes(tag))
      }))
      .sort((a, b) => b.sharedTags.length - a.sharedTags.length) // Sort by number of shared tags
      .slice(0, 3); // Maximum 3 related posts

    return {
      params: { slug: post.slug },
      props: { post, relatedPosts },
    };
  });
}

const { post, relatedPosts } = Astro.props;
const { Content, headings } = await post.render();
---

<Post
  title={post.data.title}
  date={post.data.date}
  description={post.data.description}
  draft={post.data.draft}
  slug={post.slug}
  tags={post.data.tags}
  relatedPosts={relatedPosts}
  headings={headings}
>
  <Content />
</Post>

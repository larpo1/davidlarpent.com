---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';
import PostListItem from '../components/PostListItem.astro';

const isDev = import.meta.env.DEV;

// Get all posts and sort by date (newest first)
// In dev mode: include all posts (drafts visible via toggle)
// In production: only published posts
const allPosts = await getCollection('posts');
const posts = isDev
  ? allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  : allPosts
      .filter(post => !post.data.draft)
      .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// JSON-LD WebSite Schema
const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "David Larpent",
  "description": "Notes on philosophy, AI, cognitive science, and more.",
  "url": "https://davidlarpent.com",
  "author": {
    "@type": "Person",
    "name": "David Larpent",
    "url": "https://davidlarpent.com/about"
  },
  "inLanguage": "en"
};
---

<Base title="David Larpent">
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />

  <div class="tab-navigation">
    <button
      class="tab-button"
      data-tab="work"
      aria-pressed="true"
    >
      Work
    </button>
    <button
      class="tab-button"
      data-tab="not-work"
      aria-pressed="false"
    >
      Not work
    </button>
    <div class="tab-underline" aria-hidden="true"></div>
  </div>

  <ul class="post-list">
    {posts.map(post => (
      <PostListItem
        slug={post.slug}
        title={post.data.title}
        date={post.data.date}
        description={post.data.description}
        tags={post.data.tags}
        draft={post.data.draft}
        category={post.data.category || 'work'}
      />
    ))}
  </ul>

  {isDev && (
    <div class="drafts-toggle">
      <label class="toggle-pill">
        <input type="checkbox" id="show-drafts" checked />
        <span class="toggle-slider"></span>
        <span class="toggle-text">Drafts</span>
      </label>
    </div>
  )}
</Base>

<script is:inline>
  // Tab Navigation
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabUnderline = document.querySelector('.tab-underline');
  const postItems = document.querySelectorAll('.post-list-item');

  // Hide all posts immediately to prevent flash
  postItems.forEach(function(post) { post.style.display = 'none'; });

  function setActiveTab(targetTab, isInitial) {
    // Update button states
    tabButtons.forEach(function(button) {
      var isActive = button.dataset.tab === targetTab;
      button.setAttribute('aria-pressed', isActive.toString());
    });

    // Move underline (skip transition on initial load)
    var activeButton = document.querySelector('[data-tab="' + targetTab + '"]');
    if (activeButton && tabUnderline) {
      var buttonRect = activeButton.getBoundingClientRect();
      var containerRect = activeButton.parentElement.getBoundingClientRect();
      var offsetLeft = buttonRect.left - containerRect.left;

      if (isInitial) {
        tabUnderline.style.transition = 'none';
      }
      tabUnderline.style.transform = 'translateX(' + offsetLeft + 'px)';
      tabUnderline.style.width = buttonRect.width + 'px';
      if (isInitial) {
        // Force reflow then restore transition
        tabUnderline.offsetWidth;
        tabUnderline.style.transition = '';
      }
    }

    // Filter posts with cascading fade-in
    var visibleIndex = 0;
    postItems.forEach(function(post) {
      var category = post.dataset.category || 'work';

      if (category === targetTab) {
        post.style.display = '';
        // Reset animation by removing class, forcing reflow, re-adding
        post.classList.remove('fade-in');
        post.offsetWidth; // force reflow
        post.style.animationDelay = (visibleIndex * 60) + 'ms';
        post.classList.add('fade-in');
        visibleIndex++;
      } else {
        post.style.display = 'none';
        post.classList.remove('fade-in');
      }
    });

    // Update URL
    var url = new URL(window.location);
    url.searchParams.set('tab', targetTab);
    if (isInitial) {
      history.replaceState({}, '', url);
    } else {
      history.pushState({}, '', url);
    }
  }

  // Tab click handlers
  tabButtons.forEach(function(button) {
    button.addEventListener('click', function() {
      setActiveTab(button.dataset.tab, false);
    });
  });

  // Initialize immediately (no DOMContentLoaded delay)
  var urlParams = new URLSearchParams(window.location.search);
  var initialTab = urlParams.get('tab') || 'work';
  setActiveTab(initialTab, true);

  // Handle browser back/forward
  window.addEventListener('popstate', function() {
    var params = new URLSearchParams(window.location.search);
    var tab = params.get('tab') || 'work';
    setActiveTab(tab, false);
  });
</script>

{isDev && (
  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      const checkbox = document.getElementById('show-drafts');
      const draftPosts = document.querySelectorAll('[data-draft="true"]');

      checkbox?.addEventListener('change', (e) => {
        const showDrafts = e.target.checked;
        draftPosts.forEach(post => {
          post.style.display = showDrafts ? '' : 'none';
        });
      });
    });
  </script>
)}

<style>
  .drafts-toggle {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 100;
    opacity: 0.7;
    transition: opacity 0.2s;
  }

  .drafts-toggle:hover {
    opacity: 1;
  }

  .toggle-pill {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--color-code-bg);
    border: 1px solid var(--color-border);
    border-radius: 2rem;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .toggle-pill:hover {
    border-color: var(--color-link);
  }

  .toggle-pill input[type="checkbox"] {
    display: none;
  }

  .toggle-slider {
    position: relative;
    width: 2rem;
    height: 1rem;
    background: var(--color-border);
    border-radius: 1rem;
    transition: background 0.2s;
  }

  .toggle-slider::after {
    content: '';
    position: absolute;
    top: 0.125rem;
    left: 0.125rem;
    width: 0.75rem;
    height: 0.75rem;
    background: var(--color-background);
    border-radius: 50%;
    transition: transform 0.2s;
  }

  .toggle-pill input:checked + .toggle-slider {
    background: var(--color-link);
  }

  .toggle-pill input:checked + .toggle-slider::after {
    transform: translateX(1rem);
  }

  .toggle-text {
    font-size: 0.75rem;
    color: var(--color-text-light);
    user-select: none;
  }
</style>

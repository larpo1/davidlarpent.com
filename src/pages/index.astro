---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';

const isDev = import.meta.env.DEV;

// Get all posts and sort by date (newest first)
// In dev mode: include all posts (drafts visible via toggle)
// In production: only published posts
const allPosts = await getCollection('posts');
const posts = isDev
  ? allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  : allPosts
      .filter(post => !post.data.draft)
      .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// JSON-LD WebSite Schema
const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "David Larpent",
  "description": "Essays on philosophy, AI, cognitive science, and more.",
  "url": "https://davidlarpent.com",
  "author": {
    "@type": "Person",
    "name": "David Larpent",
    "url": "https://davidlarpent.com/about"
  },
  "inLanguage": "en"
};
---

<Base title="David Larpent">
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />

  <ul class="post-list">
    {posts.map(post => {
      const formattedDate = post.data.date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });

      return (
        <li class="post-list-item" data-draft={post.data.draft ? 'true' : 'false'}>
          <h2 class="post-list-title">
            <a href={`/posts/${post.slug}`}>{post.data.title}</a>
          </h2>
          <div class="post-meta">
            {formattedDate}
            {post.data.draft && <span class="draft-badge">Draft</span>}
          </div>
          {post.data.description && (
            <p class="post-description">{post.data.description}</p>
          )}
          {post.data.tags && post.data.tags.length > 0 && (
            <div class="post-tags">
              {post.data.tags.map(tag => (
                <a href={`/tags/${tag.toLowerCase()}`} class="tag-link">
                  #{tag}
                </a>
              ))}
            </div>
          )}
        </li>
      );
    })}
  </ul>

  {isDev && (
    <div class="drafts-toggle">
      <label class="toggle-pill">
        <input type="checkbox" id="show-drafts" checked />
        <span class="toggle-slider"></span>
        <span class="toggle-text">Drafts</span>
      </label>
    </div>
  )}
</Base>

{isDev && (
  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      const checkbox = document.getElementById('show-drafts');
      const draftPosts = document.querySelectorAll('[data-draft="true"]');

      checkbox?.addEventListener('change', (e) => {
        const showDrafts = e.target.checked;
        draftPosts.forEach(post => {
          post.style.display = showDrafts ? '' : 'none';
        });
      });
    });
  </script>
)}

<style>
  .drafts-toggle {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 100;
    opacity: 0.7;
    transition: opacity 0.2s;
  }

  .drafts-toggle:hover {
    opacity: 1;
  }

  .toggle-pill {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--color-code-bg);
    border: 1px solid var(--color-border);
    border-radius: 2rem;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .toggle-pill:hover {
    border-color: var(--color-link);
  }

  .toggle-pill input[type="checkbox"] {
    display: none;
  }

  .toggle-slider {
    position: relative;
    width: 2rem;
    height: 1rem;
    background: var(--color-border);
    border-radius: 1rem;
    transition: background 0.2s;
  }

  .toggle-slider::after {
    content: '';
    position: absolute;
    top: 0.125rem;
    left: 0.125rem;
    width: 0.75rem;
    height: 0.75rem;
    background: var(--color-background);
    border-radius: 50%;
    transition: transform 0.2s;
  }

  .toggle-pill input:checked + .toggle-slider {
    background: var(--color-link);
  }

  .toggle-pill input:checked + .toggle-slider::after {
    transform: translateX(1rem);
  }

  .toggle-text {
    font-size: 0.75rem;
    color: var(--color-text-light);
    user-select: none;
  }
</style>

---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';
import PostListItem from '../components/PostListItem.astro';
import SourceListItem from '../components/SourceListItem.astro';

const isDev = import.meta.env.DEV;

// Get all posts and sort by date (newest first)
const allPosts = await getCollection('posts');
const posts = isDev
  ? allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  : allPosts
      .filter(post => !post.data.draft)
      .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Get all sources and sort by date (newest first)
const allSources = await getCollection('sources');
const sources = isDev
  ? allSources.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  : allSources
      .filter(source => !source.data.archived)
      .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// JSON-LD WebSite Schema
const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "David Larpent",
  "description": "Notes on philosophy, AI, cognitive science, and more.",
  "url": "https://davidlarpent.com",
  "author": {
    "@type": "Person",
    "name": "David Larpent",
    "url": "https://davidlarpent.com/about"
  },
  "inLanguage": "en"
};
---

<Base title="David Larpent" keywords={["AI", "philosophy", "cognitive science", "product strategy", "essays"]}>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />

  <h1 class="sr-only">David Larpent â€” Notes on AI, Philosophy, and Product</h1>

  <div class="tab-navigation">
    <button
      class="tab-button"
      data-tab="output"
      aria-pressed="true"
    >
      Output
    </button>
    <button
      class="tab-button"
      data-tab="input"
      aria-pressed="false"
    >
      Input
    </button>
    <div class="tab-underline" aria-hidden="true"></div>
  </div>

  <ul class="post-list" data-tab-panel="output">
    {posts.map(post => (
      <PostListItem
        slug={post.slug}
        title={post.data.title}
        date={post.data.date}
        description={post.data.description}
        tags={post.data.tags}
        draft={post.data.draft}
        category={post.data.category || 'work'}
      />
    ))}
  </ul>

  <ul class="post-list" data-tab-panel="input" style="display: none;">
    {sources.map(source => (
      <SourceListItem
        slug={source.slug}
        title={source.data.title}
        author={source.data.author}
        type={source.data.type}
        date={source.data.date}
        tags={source.data.tags}
      />
    ))}
  </ul>

  {isDev && (
    <div class="drafts-toggle">
      <label class="toggle-pill">
        <input type="checkbox" id="show-drafts" checked />
        <span class="toggle-slider"></span>
        <span class="toggle-text">Drafts</span>
      </label>
    </div>
  )}
</Base>

<script is:inline>
  // Tab Navigation
  var tabButtons = document.querySelectorAll('.tab-button');
  var tabUnderline = document.querySelector('.tab-underline');
  var tabPanels = document.querySelectorAll('[data-tab-panel]');
  var draftsToggle = document.querySelector('.drafts-toggle');

  // Map old tab names to new ones for backward compatibility
  var tabMap = { 'work': 'output', 'not-work': 'output' };

  function setActiveTab(targetTab, isInitial) {
    // Map old tab names
    targetTab = tabMap[targetTab] || targetTab;
    // Fallback to output if invalid
    if (targetTab !== 'output' && targetTab !== 'input') targetTab = 'output';

    // Update button states
    tabButtons.forEach(function(button) {
      var isActive = button.dataset.tab === targetTab;
      button.setAttribute('aria-pressed', isActive.toString());
    });

    // Move underline
    var activeButton = document.querySelector('[data-tab="' + targetTab + '"]');
    if (activeButton && tabUnderline) {
      var buttonRect = activeButton.getBoundingClientRect();
      var containerRect = activeButton.parentElement.getBoundingClientRect();
      var offsetLeft = buttonRect.left - containerRect.left;

      if (isInitial) {
        tabUnderline.style.transition = 'none';
      }
      tabUnderline.style.transform = 'translateX(' + offsetLeft + 'px)';
      tabUnderline.style.width = buttonRect.width + 'px';
      if (isInitial) {
        tabUnderline.offsetWidth;
        tabUnderline.style.transition = '';
      }
    }

    // Show/hide panels
    tabPanels.forEach(function(panel) {
      if (panel.getAttribute('data-tab-panel') === targetTab) {
        panel.style.display = '';
        // Fade in items
        var items = panel.querySelectorAll('.post-list-item');
        items.forEach(function(item, i) {
          item.classList.remove('fade-in');
          item.offsetWidth;
          item.style.animationDelay = (i * 60) + 'ms';
          item.classList.add('fade-in');
        });
      } else {
        panel.style.display = 'none';
      }
    });

    // Show drafts toggle only on output tab
    if (draftsToggle) {
      draftsToggle.style.display = targetTab === 'output' ? '' : 'none';
    }

    // Update URL
    var url = new URL(window.location);
    url.searchParams.set('tab', targetTab);
    if (isInitial) {
      history.replaceState({}, '', url);
    } else {
      history.pushState({}, '', url);
    }
  }

  // Tab click handlers
  tabButtons.forEach(function(button) {
    button.addEventListener('click', function() {
      setActiveTab(button.dataset.tab, false);
    });
  });

  // Initialize
  var urlParams = new URLSearchParams(window.location.search);
  var initialTab = urlParams.get('tab') || 'output';
  setActiveTab(initialTab, true);

  // Handle browser back/forward
  window.addEventListener('popstate', function() {
    var params = new URLSearchParams(window.location.search);
    var tab = params.get('tab') || 'output';
    setActiveTab(tab, false);
  });
</script>

{isDev && (
  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      const checkbox = document.getElementById('show-drafts');
      const draftPosts = document.querySelectorAll('[data-draft="true"]');

      checkbox?.addEventListener('change', (e) => {
        const showDrafts = e.target.checked;
        draftPosts.forEach(post => {
          post.style.display = showDrafts ? '' : 'none';
        });
      });
    });
  </script>
)}

<style>
  .drafts-toggle {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 100;
    opacity: 0.7;
    transition: opacity 0.2s;
  }

  .drafts-toggle:hover {
    opacity: 1;
  }

  .toggle-pill {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--color-code-bg);
    border: 1px solid var(--color-border);
    border-radius: 2rem;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .toggle-pill:hover {
    border-color: var(--color-link);
  }

  .toggle-pill input[type="checkbox"] {
    display: none;
  }

  .toggle-slider {
    position: relative;
    width: 2rem;
    height: 1rem;
    background: var(--color-border);
    border-radius: 1rem;
    transition: background 0.2s;
  }

  .toggle-slider::after {
    content: '';
    position: absolute;
    top: 0.125rem;
    left: 0.125rem;
    width: 0.75rem;
    height: 0.75rem;
    background: var(--color-background);
    border-radius: 50%;
    transition: transform 0.2s;
  }

  .toggle-pill input:checked + .toggle-slider {
    background: #6ba4ff;
  }

  .toggle-pill input:checked + .toggle-slider::after {
    transform: translateX(1rem);
  }

  .toggle-text {
    font-size: 0.75rem;
    color: var(--color-text-light);
    user-select: none;
  }
</style>

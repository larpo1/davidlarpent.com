---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';

const isDev = import.meta.env.DEV;

// Get all posts and sort by date (newest first)
// In dev mode: include all posts (drafts visible via toggle)
// In production: only published posts
const allPosts = await getCollection('posts');
const posts = isDev
  ? allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  : allPosts
      .filter(post => !post.data.draft)
      .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// JSON-LD WebSite Schema
const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "David Larpent",
  "description": "Essays on philosophy, AI, cognitive science, and more.",
  "url": "https://davidlarpent.com",
  "author": {
    "@type": "Person",
    "name": "David Larpent",
    "url": "https://davidlarpent.com/about"
  },
  "inLanguage": "en"
};
---

<Base title="David Larpent">
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />

  <div class="tab-navigation">
    <button
      class="tab-button"
      data-tab="not-work"
      aria-pressed="true"
    >
      Not work
    </button>
    <button
      class="tab-button"
      data-tab="work"
      aria-pressed="false"
    >
      Work
    </button>
    <div class="tab-underline" aria-hidden="true"></div>
  </div>

  <ul class="post-list">
    {posts.map(post => {
      const formattedDate = post.data.date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });

      return (
        <li
          class="post-list-item"
          data-category={post.data.category || 'work'}
          data-draft={post.data.draft ? 'true' : 'false'}
        >
          <h2 class="post-list-title">
            <a href={`/posts/${post.slug}`}>{post.data.title}</a>
          </h2>
          <div class="post-meta">
            {formattedDate}
            {post.data.draft && <span class="draft-badge">Draft</span>}
          </div>
          {post.data.description && (
            <p class="post-description">{post.data.description}</p>
          )}
          {post.data.tags && post.data.tags.length > 0 && (
            <div class="post-tags">
              {post.data.tags.map(tag => (
                <a href={`/tags/${tag.toLowerCase()}`} class="tag-link">
                  #{tag}
                </a>
              ))}
            </div>
          )}
        </li>
      );
    })}
  </ul>

  {isDev && (
    <div class="drafts-toggle">
      <label class="toggle-pill">
        <input type="checkbox" id="show-drafts" checked />
        <span class="toggle-slider"></span>
        <span class="toggle-text">Drafts</span>
      </label>
    </div>
  )}
</Base>

<script is:inline>
  // Tab Navigation
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabUnderline = document.querySelector('.tab-underline');
  const postItems = document.querySelectorAll('.post-list-item');

  function setActiveTab(targetTab) {
    // Update button states
    tabButtons.forEach(button => {
      const isActive = button.dataset.tab === targetTab;
      button.setAttribute('aria-pressed', isActive.toString());
    });

    // Move underline
    const activeButton = document.querySelector(`[data-tab="${targetTab}"]`);
    if (activeButton && tabUnderline) {
      const buttonRect = activeButton.getBoundingClientRect();
      const containerRect = activeButton.parentElement.getBoundingClientRect();
      const offsetLeft = buttonRect.left - containerRect.left;

      tabUnderline.style.transform = `translateX(${offsetLeft}px)`;
      tabUnderline.style.width = `${buttonRect.width}px`;
    }

    // Filter posts
    postItems.forEach((post, index) => {
      const category = post.dataset.category || 'work';

      if (category === targetTab) {
        post.style.display = '';
        post.style.animationDelay = `${index * 50}ms`;
      } else {
        post.style.display = 'none';
        post.style.animationDelay = '0ms';
      }
    });

    // Update URL
    const url = new URL(window.location);
    url.searchParams.set('tab', targetTab);
    history.pushState({}, '', url);
  }

  // Tab click handlers
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      setActiveTab(button.dataset.tab);
    });
  });

  // Initialize from URL or default to "not-work"
  function initializeTabs() {
    const urlParams = new URLSearchParams(window.location.search);
    const initialTab = urlParams.get('tab') || 'not-work';
    setActiveTab(initialTab);
  }

  // Run on page load
  document.addEventListener('DOMContentLoaded', initializeTabs);

  // Handle browser back/forward
  window.addEventListener('popstate', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab') || 'not-work';
    setActiveTab(tab);
  });
</script>

{isDev && (
  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      const checkbox = document.getElementById('show-drafts');
      const draftPosts = document.querySelectorAll('[data-draft="true"]');

      checkbox?.addEventListener('change', (e) => {
        const showDrafts = e.target.checked;
        draftPosts.forEach(post => {
          post.style.display = showDrafts ? '' : 'none';
        });
      });
    });
  </script>
)}

<style>
  .drafts-toggle {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 100;
    opacity: 0.7;
    transition: opacity 0.2s;
  }

  .drafts-toggle:hover {
    opacity: 1;
  }

  .toggle-pill {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--color-code-bg);
    border: 1px solid var(--color-border);
    border-radius: 2rem;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .toggle-pill:hover {
    border-color: var(--color-link);
  }

  .toggle-pill input[type="checkbox"] {
    display: none;
  }

  .toggle-slider {
    position: relative;
    width: 2rem;
    height: 1rem;
    background: var(--color-border);
    border-radius: 1rem;
    transition: background 0.2s;
  }

  .toggle-slider::after {
    content: '';
    position: absolute;
    top: 0.125rem;
    left: 0.125rem;
    width: 0.75rem;
    height: 0.75rem;
    background: var(--color-background);
    border-radius: 50%;
    transition: transform 0.2s;
  }

  .toggle-pill input:checked + .toggle-slider {
    background: var(--color-link);
  }

  .toggle-pill input:checked + .toggle-slider::after {
    transform: translateX(1rem);
  }

  .toggle-text {
    font-size: 0.75rem;
    color: var(--color-text-light);
    user-select: none;
  }
</style>
